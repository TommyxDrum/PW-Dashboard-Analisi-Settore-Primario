<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AgrItalia • Efficienza Idrica</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" th:href="@{/css/common.css}"/>
  <link rel="stylesheet" th:href="@{/css/efficienzaIdrica.css}"/>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>

<header class="header-bar">
  <a th:href="@{'/'}" class="btn btn-outline-secondary btn-back" aria-label="Torna alla Dashboard">
    <i class="bi bi-arrow-left"></i>
  </a>
  <h1 class="header-logo display-6 fs-4 mb-0">
    <i class="bi bi-droplet-fill me-2" style="color: var(--info-color)"></i>
    Efficienza Idrica
  </h1>
  <a id="exportLink" href="#" class="btn btn-outline-success ms-auto"
     aria-label="Esporta i dati filtrati in formato CSV">
    <i class="bi bi-download me-1"></i>
    <span class="d-none d-sm-inline">Export</span>
  </a>
</header>

<div class="container-fluid py-4">

  <div class="dashboard-card p-3 mb-4">
    <form id="filterForm" th:action="@{/efficienzaIdrica}" method="get"
          class="filters-bar" role="group" aria-label="Filtri efficienza idrica">
      <!-- Filtri mese, anno, coltura, area -->
      <div class="form-group">
        <label class="form-label small text-muted mb-1 fw-semibold" for="monthSel">Mese</label>
        <select id="monthSel" class="form-select" aria-label="Seleziona mese">
          <option value="1"  th:selected="${from != null and #temporals.month(from) == 1 }">Gennaio</option>
          <option value="2"  th:selected="${from != null and #temporals.month(from) == 2 }">Febbraio</option>
          <option value="3"  th:selected="${from != null and #temporals.month(from) == 3 }">Marzo</option>
          <option value="4"  th:selected="${from != null and #temporals.month(from) == 4 }">Aprile</option>
          <option value="5"  th:selected="${from != null and #temporals.month(from) == 5 }">Maggio</option>
          <option value="6"  th:selected="${from != null and #temporals.month(from) == 6 }">Giugno</option>
          <option value="7"  th:selected="${from != null and #temporals.month(from) == 7 }">Luglio</option>
          <option value="8"  th:selected="${from != null and #temporals.month(from) == 8 }">Agosto</option>
          <option value="9"  th:selected="${from != null and #temporals.month(from) == 9 }">Settembre</option>
          <option value="10" th:selected="${from != null and #temporals.month(from) == 10}">Ottobre</option>
          <option value="11" th:selected="${from != null and #temporals.month(from) == 11}">Novembre</option>
          <option value="12" th:selected="${from != null and #temporals.month(from) == 12}">Dicembre</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label small text-muted mb-1 fw-semibold" for="yearSel">Anno</label>
        <select id="yearSel" class="form-select" aria-label="Seleziona anno">
          <option th:each="y:${#numbers.sequence(2015,2025)}"
                  th:value="${y}"
                  th:text="${y}"
                  th:selected="${from!=null ? #temporals.year(from)==y : y==#temporals.year(#temporals.createNow())}">
            2025
          </option>
        </select>
      </div>

      <div class="form-group" style="min-width:180px">
        <label class="form-label small text-muted mb-1 fw-semibold" for="cropSel">Coltura</label>
        <select id="cropSel" name="crop" class="form-select" aria-label="Seleziona coltura">
          <option value="">Tutte le colture</option>
          <option th:each="c:${cropsList}" th:value="${c}" th:text="${c}"
                  th:selected="${c==crop}">Coltura</option>
        </select>
      </div>

      <div class="form-group" style="min-width:180px">
        <label class="form-label small text-muted mb-1 fw-semibold" for="areaSel">Area</label>
        <select id="areaSel" name="area" class="form-select" aria-label="Seleziona area">
          <option value="">Tutte le aree</option>
          <option th:each="a:${areasList}" th:value="${a}" th:text="${a}"
                  th:selected="${a==area}">Area</option>
        </select>
      </div>

      <button type="submit" class="btn btn-primary">
        <i class="bi bi-funnel me-2"></i>
        <span>Applica</span>
      </button>

      <input type="hidden" id="from" name="startDate"
             th:value="${from!=null ? #temporals.format(from,'yyyy-MM-dd') : ''}"/>
      <input type="hidden" id="to" name="endDate"
             th:value="${to!=null ? #temporals.format(to,'yyyy-MM-dd') : ''}"/>
    </form>
  </div>

  <!-- Card KPI -->
  <div class="row g-4 mb-4">
    <div class="col-12 col-md-4">
      <div class="kpi-box prod">
        <p class="small text-muted mb-2 fw-semibold">
          <i class="bi bi-box-seam-fill kpi-icon" style="color: var(--kpi-prod-border)"></i>
          PRODUZIONE TOTALE
        </p>
        <div class="d-flex align-items-baseline">
          <span class="kpi-value" style="color: var(--kpi-prod-border)"
                th:text="${#numbers.formatDecimal(totalYieldT,1,'POINT',0,'COMMA')}">0</span>
          <span class="ms-2 text-muted fw-medium">t</span>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="kpi-box water">
        <p class="small text-muted mb-2 fw-semibold">
          <i class="bi bi-droplet-fill kpi-icon" style="color: var(--kpi-water-border)"></i>
          VOLUME IDRICO TOTALE
        </p>
        <div class="d-flex align-items-baseline">
          <span class="kpi-value" style="color: var(--kpi-water-border)"
                th:text="${#numbers.formatDecimal(totalWaterM3,1,'POINT',0,'COMMA')}">0</span>
          <span class="ms-2 text-muted fw-medium">m³</span>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="kpi-box eff">
        <p class="small text-muted mb-2 fw-semibold">
          <i class="bi bi-water kpi-icon" style="color: var(--kpi-eff-border)"></i>
          EFFICIENZA IDRICA MEDIA
        </p>
        <div class="d-flex align-items-baseline">
          <span class="kpi-value" style="color: var(--kpi-eff-border)"
                th:text="${#numbers.formatDecimal(totalEfficiency,1,'POINT',2,'COMMA')}">0,00</span>
          <span class="ms-2 text-muted fw-medium">Kg/m³</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Sezione grafici: mensile + scatter -->
  <div class="dashboard-card p-4 mb-4">
    <div class="row g-4">
      <!-- Grafico mensile -->
      <div class="col-lg-7">
        <div class="section-header info-border header-line">
          <div class="left">
            <h2 class="h6 mb-0 fw-bold" style="color: var(--info-color)">
              <i class="bi bi-graph-up me-2"></i>
              Andamento Efficienza Idrica Mensile
            </h2>
            <span class="badge bg-info bg-opacity-10 text-info"
                  th:text="${crop != null && !crop.isEmpty() ? crop : 'Tutte le Colture'}">
              Tutte le Colture
            </span>
          </div>
        </div>

        <p class="subtitle mb-3">
          Evoluzione dell'<strong>efficienza idrica (Kg/m³)</strong> per area geografica
          nel mese selezionato (valori giornalieri).
        </p>
        <div class="chart-container">
          <canvas id="efficiencyMonthlyTrend" role="img"
                  aria-label="Grafico a linee sull'andamento dell'efficienza idrica giornaliera nel mese selezionato."></canvas>
        </div>
      </div>

      <!-- Grafico scatter produzione vs consumo idrico -->
      <div class="col-lg-5">
        <div class="section-header header-line">
          <div class="left">
            <h3 class="h6 mb-0 fw-bold text-primary">
              <i class="bi bi-scatter-chart me-2"></i>
              Produzione vs Consumo Idrico
            </h3>
            <span class="badge bg-primary bg-opacity-10 text-primary"
                  th:text="${crop != null && !crop.isEmpty() ? crop : 'Tutte le Colture'}">
              Tutte le Colture
            </span>
          </div>
        </div>
        <p class="subtitle mb-3">
          Posizionamento delle aree in base a <strong>produzione (t)</strong> e
          <strong>consumo idrico (m³)</strong> nel periodo filtrato.
        </p>
        <div id="echScatterEfficiency" class="chart-container"
             role="img" aria-label="Grafico a dispersione produzione vs consumo idrico."></div>
      </div>
    </div>
  </div>

  <!-- Sezione grafico annuale -->
  <div class="dashboard-card p-4 mb-4">
    <div class="section-header info-border header-line">
      <div class="left">
        <h2 class="h6 mb-0 fw-bold" style="color: var(--info-color)">
          <i class="bi bi-graph-up me-2"></i>
          Andamento Efficienza Idrica Annuale
        </h2>
        <span class="badge bg-info bg-opacity-10 text-info"
              th:text="${crop != null && !crop.isEmpty() ? crop : 'Tutte le Colture'}">
          Tutte le Colture
        </span>
      </div>
    </div>
    <p class="subtitle mb-3">
      Evoluzione dell'<strong>efficienza idrica (Kg/m³)</strong> per area geografica
      nel corso degli anni.
    </p>
    <div class="chart-container">
      <canvas id="efficiencyAnnualTrend" role="img"
              aria-label="Grafico a linee sull'andamento dell'efficienza idrica negli anni."></canvas>
    </div>
  </div>

  <!-- Tabella dettagli -->
  <div class="dashboard-card p-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <h3 class="h6 mb-0 fw-bold" style="color: var(--info-color)">
        <i class="bi bi-table me-2"></i>
        Dettaglio Dati per Area
      </h3>
      <span class="badge bg-secondary"
            th:text="${crop != null && !crop.isEmpty() ? crop : 'Tutte le colture'}">
        Tutte le colture
      </span>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
        <tr>
          <th scope="col">Area</th>
          <th scope="col" class="text-end">Produzione (t)</th>
          <th scope="col" class="text-end">Consumo Idrico (m³)</th>
          <th scope="col" class="text-end">Efficienza (Kg/m³)</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="r:${efficienzaRows}">
          <td>
            <span class="fw-semibold" th:text="${r.area}">Area</span>
          </td>
          <td class="text-end"
              th:text="${#numbers.formatDecimal(r.yieldT,1,'POINT',2,'COMMA')}">0,00</td>
          <td class="text-end"
              th:text="${#numbers.formatDecimal(r.waterM3,1,'POINT',2,'COMMA')}">0,00</td>
          <td class="text-end fw-bold" style="color: var(--info-color)"
              th:text="${#numbers.formatDecimal(r.efficiencyKgM3,1,'POINT',2,'COMMA')}">0,00</td>
        </tr>
        </tbody>
        <tfoot class="table-light">
        <tr>
          <th scope="row">
            <i class="bi bi-calculator me-2"></i>Totale
          </th>
          <th class="text-end"
              th:text="${#numbers.formatDecimal(totalYieldT,1,'POINT',2,'COMMA')}">0,00</th>
          <th class="text-end"
              th:text="${#numbers.formatDecimal(totalWaterM3,1,'POINT',2,'COMMA')}">0,00</th>
          <th class="text-end" style="color: var(--info-color)"
              th:text="${#numbers.formatDecimal(totalEfficiency,1,'POINT',2,'COMMA')}">0,00</th>
        </tr>
        </tfoot>
      </table>
      <p class="caption mt-3">
        <i class="bi bi-info-circle me-1"></i>
        I totali e i valori in tabella si riferiscono al periodo filtrato (mese/anno selezionati).
      </p>
    </div>
  </div>

  <footer class="text-center py-4 mt-5 border-top">
    <p class="text-muted small mb-0">
      &copy; <span th:text="${#temporals.year(#temporals.createNow())}">2025</span>
      AgrItalia S.p.A. | Dashboard Agronomica
    </p>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/common.js}"></script>

<script th:inline="javascript">
  window.efficienzaData = {
    years: [[${years}]],
    annualEfficiencyNord: [[${annualEfficiencyNord}]],
    annualEfficiencyCentro: [[${annualEfficiencyCentro}]],
    annualEfficiencySud: [[${annualEfficiencySud}]],
    area: [[${area}]],
    waterNordM3: [[${waterNordM3}]],
    waterCentroM3: [[${waterCentroM3}]],
    waterSudM3: [[${waterSudM3}]],
    yieldNordT: [[${yieldNordT}]],
    yieldCentroT: [[${yieldCentroT}]],
    yieldSudT: [[${yieldSudT}]],
    // Serie mensile per grafico giornaliero dell'efficienza idrica
    dailyLabels: [[${dailyLabels}]],
    dailyEfficiencyNord: [[${dailyEfficiencyNord}]],
    dailyEfficiencyCentro: [[${dailyEfficiencyCentro}]],
    dailyEfficiencySud: [[${dailyEfficiencySud}]]
  };
</script>
<script th:src="@{/js/efficienzaIdrica.js}"></script>

</body>
</html>
