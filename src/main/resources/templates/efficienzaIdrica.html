<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Agronomica • Efficienza Idrica</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --primary-green: #198754;
      --secondary-blue: #0d6efd;
      --light-bg: #f8f9fa;
      --purple: #6f42c1;
      --info-color: #0dcaf0;
      --warning-accessible: #e09400;
      --focus-ring: 0 0 0 0.25rem rgba(13, 110, 253, .25);
      --control-h: 44px;
      --area-nord: #0d6efd;
      --area-centro: #D96D00;
      --area-sud: #10b981;
      --kpi-prod-bg: #f7f2ff;
      --kpi-prod-border: var(--purple);
      --kpi-water-bg: #eef6ff;
      --kpi-water-border: var(--secondary-blue);
      --kpi-eff-bg: #e7fbff;
      --kpi-eff-border: var(--info-color);
    }

    body {
      background-color: var(--light-bg);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding-top: 70px;
    }

    .dashboard-card {
      border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0,0,0,.08);
      background: #fff;
      height: 100%;
      transition: box-shadow 0.3s ease;
    }

    .dashboard-card:hover {
      box-shadow: 0 6px 16px rgba(0,0,0,.12);
    }

    .header-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1040;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .header-logo {
      font-weight: 700;
      color: var(--primary-green);
      line-height: 1;
      margin: 0;
      letter-spacing: -0.5px;
    }

    .btn-back {
      height: var(--control-h);
      width: var(--control-h);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.375rem;
      transition: all 0.2s ease;
    }

    .btn-back:hover {
      transform: translateX(-3px);
    }

    .filters-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      gap: .75rem;
      width: 100%;
      padding-bottom: .25rem;
    }

    .filters-bar .form-group {
      flex: 1 1 140px;
      min-width: 140px;
    }

    .filters-bar .form-select {
      height: var(--control-h);
      padding: 0 2.5rem 0 .875rem;
      background-position: right .875rem center;
      border: 1px solid #dee2e6;
      transition: all 0.2s ease;
    }

    .filters-bar .form-select:hover {
      border-color: var(--secondary-blue);
    }

    .filters-bar .btn-primary {
      height: var(--control-h);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0 1.5rem;
      flex: 0 0 auto;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .filters-bar .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
    }

    .form-select:focus, .btn:focus {
      box-shadow: var(--focus-ring);
    }

    .section-header {
      padding-bottom: .5rem;
      margin-bottom: 1.25rem;
      border-bottom: 3px solid var(--secondary-blue);
      position: relative;
    }

    .section-header::after {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 0;
      width: 60px;
      height: 3px;
      background: currentColor;
      border-radius: 3px 3px 0 0;
    }

    .section-header.info-border {
      border-color: var(--info-color);
    }

    .section-header.info-border::after {
      background: var(--info-color);
    }

    .subtitle {
      color: #5f676d;
      font-size: .9375rem;
      line-height: 1.5;
    }

    .caption {
      color: #8a8f94;
      font-size: .8125rem;
    }

    .kpi-box {
      padding: 1.25rem;
      border-radius: .75rem;
      border-left: 5px solid;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .kpi-box::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 80px;
      height: 80px;
      background: currentColor;
      opacity: 0.03;
      border-radius: 50%;
      transform: translate(30%, -30%);
    }

    .kpi-box:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0,0,0,.12);
    }

    .kpi-box.prod {
      background-color: var(--kpi-prod-bg);
      border-left-color: var(--kpi-prod-border);
    }

    .kpi-box.water {
      background-color: var(--kpi-water-bg);
      border-left-color: var(--kpi-water-border);
    }

    .kpi-box.eff {
      background-color: var(--kpi-eff-bg);
      border-left-color: var(--kpi-eff-border);
    }

    .kpi-value {
      font-size: 2.25rem;
      font-weight: 700;
      line-height: 1.2;
    }

    .kpi-icon {
      font-size: 1.25rem;
      margin-right: 0.5rem;
    }

    .header-line {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
    }

    .header-line .left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .badge {
      font-weight: 600;
      padding: 0.5rem 0.875rem;
      font-size: 0.8125rem;
    }

    .btn-outline-success {
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn-outline-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
    }

    .chart-container {
      position: relative;
      height: 360px;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 200px;
      color: var(--info-color);
      font-size: 1.125rem;
      font-weight: 500;
    }

    .table {
      font-size: 0.9375rem;
    }

    .table thead th {
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.8125rem;
      letter-spacing: 0.5px;
      color: #6c757d;
    }

    .table tbody tr {
      transition: background-color 0.2s ease;
    }

    .table tbody tr:hover {
      background-color: rgba(13, 110, 253, 0.03);
    }

    .table tfoot th {
      font-weight: 700;
      border-top: 2px solid #dee2e6;
      padding-top: 1rem;
    }

    @media (max-width: 768px) {
      .kpi-value {
        font-size: 1.75rem;
      }

      .filters-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .filters-bar .form-group {
        width: 100%;
        min-width: 100%;
      }

      .filters-bar .btn-primary {
        width: 100%;
      }

      .header-line {
        flex-direction: column;
        align-items: flex-start;
      }

      .chart-container {
        height: 280px;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .dashboard-card {
      animation: fadeIn 0.5s ease-out;
    }

    .kpi-box {
      animation: fadeIn 0.6s ease-out;
    }

    footer {
      font-size: 0.875rem;
      opacity: 0.7;
    }
  </style>
</head>
<body>

<header class="header-bar">
  <a href="/" class="btn btn-outline-secondary btn-back" aria-label="Torna alla Dashboard">
    <i class="bi bi-arrow-left"></i>
  </a>
  <h1 class="header-logo display-6 fs-4 mb-0">
    <i class="bi bi-droplet-fill me-2" style="color: var(--info-color)"></i>
    Efficienza Idrica
  </h1>
  <a id="exportLink" href="#" class="btn btn-outline-success ms-auto"
     aria-label="Esporta i dati filtrati in formato CSV">
    <i class="bi bi-download me-1"></i>
    <span class="d-none d-sm-inline">Export</span>
  </a>
</header>

<div class="container-fluid py-4">

  <div class="dashboard-card p-3 mb-4">
    <form id="filterForm" action="/efficienzaIdrica" method="get"
          class="filters-bar" role="group" aria-label="Filtri efficienza idrica">
      <div class="form-group">
        <label class="form-label small text-muted mb-1 fw-semibold" for="monthSel">Mese</label>
        <select id="monthSel" class="form-select" aria-label="Seleziona mese">
          <option value="1"  th:selected="${from != null and #temporals.month(from) == 1 }">Gennaio</option>
          <option value="2"  th:selected="${from != null and #temporals.month(from) == 2 }">Febbraio</option>
          <option value="3"  th:selected="${from != null and #temporals.month(from) == 3 }">Marzo</option>
          <option value="4"  th:selected="${from != null and #temporals.month(from) == 4 }">Aprile</option>
          <option value="5"  th:selected="${from != null and #temporals.month(from) == 5 }">Maggio</option>
          <option value="6"  th:selected="${from != null and #temporals.month(from) == 6 }">Giugno</option>
          <option value="7"  th:selected="${from != null and #temporals.month(from) == 7 }">Luglio</option>
          <option value="8"  th:selected="${from != null and #temporals.month(from) == 8 }">Agosto</option>
          <option value="9"  th:selected="${from != null and #temporals.month(from) == 9 }">Settembre</option>
          <option value="10" th:selected="${from != null and #temporals.month(from) == 10}">Ottobre</option>
          <option value="11" th:selected="${from != null and #temporals.month(from) == 11}">Novembre</option>
          <option value="12" th:selected="${from != null and #temporals.month(from) == 12}">Dicembre</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label small text-muted mb-1 fw-semibold" for="yearSel">Anno</label>
        <select id="yearSel" class="form-select" aria-label="Seleziona anno">
          <option th:each="y:${#numbers.sequence(2015,2025)}"
                  th:value="${y}"
                  th:text="${y}"
                  th:selected="${from!=null ? #temporals.year(from)==y : y==#temporals.year(#temporals.createNow())}">
            2025
          </option>
        </select>
      </div>

      <div class="form-group" style="min-width:180px">
        <label class="form-label small text-muted mb-1 fw-semibold" for="cropSel">Coltura</label>
        <select id="cropSel" name="crop" class="form-select" aria-label="Seleziona coltura">
          <option value="">Tutte le colture</option>
          <option th:each="c:${cropsList}" th:value="${c}" th:text="${c}"
                  th:selected="${c==crop}">Coltura</option>
        </select>
      </div>

      <div class="form-group" style="min-width:180px">
        <label class="form-label small text-muted mb-1 fw-semibold" for="areaSel">Area</label>
        <select id="areaSel" name="area" class="form-select" aria-label="Seleziona area">
          <option value="">Tutte le aree</option>
          <option th:each="a:${areasList}" th:value="${a}" th:text="${a}"
                  th:selected="${a==area}">Area</option>
        </select>
      </div>

      <button type="submit" class="btn btn-primary">
        <i class="bi bi-funnel me-2"></i>
        <span>Applica</span>
      </button>

      <input type="hidden" id="from" name="from"
             th:value="${from!=null ? #temporals.format(from,'yyyy-MM-dd') : ''}"/>
      <input type="hidden" id="to" name="to"
             th:value="${to!=null ? #temporals.format(to,'yyyy-MM-dd') : ''}"/>
    </form>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-12 col-md-4">
      <div class="kpi-box prod">
        <p class="small text-muted mb-2 fw-semibold">
          <i class="bi bi-box-seam-fill kpi-icon" style="color: var(--kpi-prod-border)"></i>
          PRODUZIONE TOTALE
        </p>
        <div class="d-flex align-items-baseline">
          <span class="kpi-value" style="color: var(--kpi-prod-border)"
                th:text="${#numbers.formatDecimal(totalYieldT,1,'POINT',0,'COMMA')}">0</span>
          <span class="ms-2 text-muted fw-medium">t</span>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="kpi-box water">
        <p class="small text-muted mb-2 fw-semibold">
          <i class="bi bi-droplet-fill kpi-icon" style="color: var(--kpi-water-border)"></i>
          VOLUME IDRICO TOTALE
        </p>
        <div class="d-flex align-items-baseline">
          <span class="kpi-value" style="color: var(--kpi-water-border)"
                th:text="${#numbers.formatDecimal(totalWaterM3,1,'POINT',0,'COMMA')}">0</span>
          <span class="ms-2 text-muted fw-medium">m³</span>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="kpi-box eff">
        <p class="small text-muted mb-2 fw-semibold">
          <i class="bi bi-water kpi-icon" style="color: var(--kpi-eff-border)"></i>
          EFFICIENZA IDRICA MEDIA
        </p>
        <div class="d-flex align-items-baseline">
          <span class="kpi-value" style="color: var(--kpi-eff-border)"
                th:text="${#numbers.formatDecimal(totalEfficiency,1,'POINT',2,'COMMA')}">0,00</span>
          <span class="ms-2 text-muted fw-medium">Kg/m³</span>
        </div>
      </div>
    </div>
  </div>

  <div class="dashboard-card p-4 mb-4">
    <div class="row g-4">
      <div class="col-lg-7">
        <div class="section-header info-border header-line">
          <div class="left">
            <h2 class="h6 mb-0 fw-bold" style="color: var(--info-color)">
              <i class="bi bi-graph-up me-2"></i>
              Andamento Efficienza Idrica Annuale
            </h2>
            <span class="badge bg-info bg-opacity-10 text-info"
                  th:text="${crop != null && !crop.isEmpty() ? crop : 'Tutte le Colture'}">
              Tutte le Colture
            </span>
          </div>
        </div>

        <p class="subtitle mb-3">
          Evoluzione dell'<strong>efficienza idrica (Kg/m³)</strong> per area geografica
          negli ultimi anni, in base alla coltura selezionata.
        </p>
        <div class="chart-container">
          <canvas id="efficiencyAnnualTrend" role="img"
                  aria-label="Grafico a linee sull'andamento dell'efficienza idrica negli anni."></canvas>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="section-header header-line">
          <div class="left">
            <h3 class="h6 mb-0 fw-bold text-primary">
              <i class="bi bi-scatter-chart me-2"></i>
              Produzione vs Consumo Idrico
            </h3>
            <span class="badge bg-primary bg-opacity-10 text-primary"
                  th:text="${crop != null && !crop.isEmpty() ? crop : 'Tutte le Colture'}">
              Tutte le Colture
            </span>
          </div>
        </div>
        <p class="subtitle mb-3">
          Posizionamento delle aree in base a <strong>produzione (t)</strong> e
          <strong>consumo idrico (m³)</strong> nel periodo filtrato.
        </p>
        <div id="echScatterEfficiency" class="chart-container"
             role="img" aria-label="Grafico a dispersione produzione vs consumo idrico."></div>
      </div>
    </div>
  </div>

  <div class="dashboard-card p-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <h3 class="h6 mb-0 fw-bold" style="color: var(--info-color)">
        <i class="bi bi-table me-2"></i>
        Dettaglio Dati per Area
      </h3>
      <span class="badge bg-secondary"
            th:text="${crop != null && !crop.isEmpty() ? crop : 'Tutte le colture'}">
        Tutte le colture
      </span>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
        <tr>
          <th scope="col">Area</th>
          <th scope="col" class="text-end">Produzione (t)</th>
          <th scope="col" class="text-end">Consumo Idrico (m³)</th>
          <th scope="col" class="text-end">Efficienza (Kg/m³)</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="r:${efficienzaRows}">
          <td>
            <span class="fw-semibold" th:text="${r.area}">Area</span>
          </td>
          <td class="text-end"
              th:text="${#numbers.formatDecimal(r.yieldT,1,'POINT',2,'COMMA')}">0,00</td>
          <td class="text-end"
              th:text="${#numbers.formatDecimal(r.waterM3,1,'POINT',2,'COMMA')}">0,00</td>
          <td class="text-end fw-bold" style="color: var(--info-color)"
              th:text="${#numbers.formatDecimal(r.efficiencyKgM3,1,'POINT',2,'COMMA')}">0,00</td>
        </tr>
        </tbody>
        <tfoot class="table-light">
        <tr>
          <th scope="row">
            <i class="bi bi-calculator me-2"></i>Totale
          </th>
          <th class="text-end"
              th:text="${#numbers.formatDecimal(totalYieldT,1,'POINT',2,'COMMA')}">0,00</th>
          <th class="text-end"
              th:text="${#numbers.formatDecimal(totalWaterM3,1,'POINT',2,'COMMA')}">0,00</th>
          <th class="text-end" style="color: var(--info-color)"
              th:text="${#numbers.formatDecimal(totalEfficiency,1,'POINT',2,'COMMA')}">0,00</th>
        </tr>
        </tfoot>
      </table>
      <p class="caption mt-3">
        <i class="bi bi-info-circle me-1"></i>
        I totali e i valori in tabella si riferiscono al periodo filtrato (mese/anno selezionati).
      </p>
    </div>
  </div>

  <footer class="text-center py-4 mt-5 border-top">
    <p class="text-muted small mb-0">
      &copy; <span th:text="${#temporals.year(#temporals.createNow())}">2025</span>
      AgrItalia S.p.A. | Dashboard Agronomica
    </p>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  (function(){
    var form = document.getElementById("filterForm");
    if(!form) return;

    var monthSel = document.getElementById("monthSel");
    var yearSel  = document.getElementById("yearSel");
    var fromI    = document.getElementById("from");
    var toI      = document.getElementById("to");

    function pad(n){ return n < 10 ? "0"+n : String(n); }

    function updateRange(){
      var y = parseInt(yearSel.value, 10);
      var m = parseInt(monthSel.value, 10);
      fromI.value = y + "-" + pad(m) + "-01";
      var lastDay = new Date(y, m, 0).getDate();
      toI.value = y + "-" + pad(m) + "-" + pad(lastDay);
      updateExportLink();
    }

    function updateExportLink(){
      var cropSel = document.getElementById("cropSel");
      var areaSel = document.getElementById("areaSel");
      var params = new URLSearchParams();
      if(fromI.value) params.set("from", fromI.value);
      if(toI.value) params.set("to", toI.value);
      if(cropSel && cropSel.value) params.set("crop", cropSel.value);
      if(areaSel && areaSel.value) params.set("area", areaSel.value);
      var el = document.getElementById("exportLink");
      if(el) el.href = "/export.csv" + (params.toString() ? ("?" + params.toString()) : "");
    }

    updateRange();
    form.addEventListener("submit", updateRange);
    if(document.getElementById("cropSel")) {
      document.getElementById("cropSel").addEventListener("change", updateExportLink);
    }
    if(document.getElementById("areaSel")) {
      document.getElementById("areaSel").addEventListener("change", updateExportLink);
    }
    monthSel.addEventListener("change", updateRange);
    yearSel.addEventListener("change", updateRange);
  })();
</script>

<script th:inline="javascript">
  (function(){
    function cssVar(n){
      var v = getComputedStyle(document.documentElement).getPropertyValue(n);
      return (v && v.trim()) || n;
    }

    var C_NORD = cssVar('--area-nord');
    var C_CENTRO = cssVar('--area-centro');
    var C_SUD = cssVar('--area-sud');

    var years = [[${years}]];
    var annualEfficiencyNord = [[${annualEfficiencyNord}]];
    var annualEfficiencyCentro = [[${annualEfficiencyCentro}]];
    var annualEfficiencySud = [[${annualEfficiencySud}]];
    var areaSel = [[${area}]];

    var waterNordM3 = [[${waterNordM3}]];
    var waterCentroM3 = [[${waterCentroM3}]];
    var waterSudM3 = [[${waterSudM3}]];
    var yieldNordT = [[${yieldNordT}]];
    var yieldCentroT = [[${yieldCentroT}]];
    var yieldSudT = [[${yieldSudT}]];

    Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    Chart.defaults.font.size = 12;

    (function(){
      var el = document.getElementById('efficiencyAnnualTrend');
      if(!el) return;

      if(!Array.isArray(years) || years.length === 0){
        el.parentElement.innerHTML = '<div class="loading"><i class="bi bi-exclamation-circle me-2"></i>Nessun dato storico disponibile</div>';
        return;
      }

      var datasets = [
        {label:'Nord', data:annualEfficiencyNord, borderColor:C_NORD, backgroundColor:C_NORD+'15'},
        {label:'Centro', data:annualEfficiencyCentro, borderColor:C_CENTRO, backgroundColor:C_CENTRO+'15'},
        {label:'Sud', data:annualEfficiencySud, borderColor:C_SUD, backgroundColor:C_SUD+'15'}
      ];

      var filtered = datasets;
      if(areaSel && String(areaSel).trim().length > 0){
        filtered = datasets.filter(function(d){
          return d.label.toLowerCase() === String(areaSel).toLowerCase();
        });
      }

      new Chart(el.getContext('2d'), {
        type: 'line',
        data: {
          labels: years,
          datasets: filtered.map(function(d){
            return {
              label: d.label,
              data: d.data,
              borderColor: d.borderColor,
              backgroundColor: d.backgroundColor,
              pointBackgroundColor: d.borderColor,
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6,
              borderWidth: 3,
              tension: 0.35,
              fill: true
            };
          })
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              title: {display:true, text:'Efficienza (Kg/m³)', font:{weight:'600', size:13}},
              grid: {color:'rgba(0,0,0,0.05)'}
            },
            x: {
              ticks: {autoSkip:true, maxTicksLimit:10},
              grid: {display:false}
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {usePointStyle:true, padding:15, font:{weight:'500'}}
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(255,255,255,0.95)',
              titleColor: '#333',
              bodyColor: '#666',
              borderColor: '#ddd',
              borderWidth: 1,
              padding: 12,
              callbacks: {
                label: function(ctx){
                  return ctx.dataset.label + ': ' + (+ctx.raw).toFixed(2) + ' Kg/m³';
                }
              }
            }
          },
          interaction: {mode:'index', intersect:false}
        }
      });
    })();

    (function(){
      var el = document.getElementById('echScatterEfficiency');
      if(!el) return;

      var chart = echarts.init(el);
      var nf0 = new Intl.NumberFormat('it-IT', {maximumFractionDigits:0});
      var nf2 = new Intl.NumberFormat('it-IT', {maximumFractionDigits:2, minimumFractionDigits:2});

      var data = [
        {
          name: 'Nord',
          value: [Number(waterNordM3) || 0, Number(yieldNordT) || 0],
          itemStyle: {color: C_NORD}
        },
        {
          name: 'Centro',
          value: [Number(waterCentroM3) || 0, Number(yieldCentroT) || 0],
          itemStyle: {color: C_CENTRO}
        },
        {
          name: 'Sud',
          value: [Number(waterSudM3) || 0, Number(yieldSudT) || 0],
          itemStyle: {color: C_SUD}
        }
      ];

      if(data.every(function(d){ return d.value[0] === 0 && d.value[1] === 0; })){
        el.innerHTML = '<div class="loading"><i class="bi bi-exclamation-circle me-2"></i>Dati non sufficienti per il confronto</div>';
        return;
      }

      chart.setOption({
        tooltip: {
          trigger: 'item',
          backgroundColor: 'rgba(255,255,255,0.95)',
          borderColor: '#ddd',
          borderWidth: 1,
          textStyle: {color: '#333'},
          padding: 12,
          formatter: function(p){
            var efficiency = p.data.value[1] > 0 && p.data.value[0] > 0
              ? (p.data.value[1] * 1000 / p.data.value[0]).toFixed(2)
              : '0.00';
            return '<b>' + p.data.name + '</b><br/>' +
                   'Consumo: ' + nf0.format(p.data.value[0]) + ' m³<br/>' +
                   'Produzione: ' + nf0.format(p.data.value[1]) + ' t<br/>' +
                   'Efficienza: ' + efficiency + ' Kg/m³';
          }
        },
        grid: {
          left: '12%',
          right: '8%',
          bottom: '12%',
          top: '8%',
          containLabel: true
        },
        xAxis: {
          type: 'value',
          name: 'Consumo Idrico (m³)',
          nameLocation: 'middle',
          nameGap: 35,
          nameTextStyle: {fontWeight: '600', fontSize: 13},
          axisLabel: {color: '#666'},
          splitLine: {lineStyle: {color: '#f0f0f0'}}
        },
        yAxis: {
          type: 'value',
          name: 'Produzione (t)',
          nameLocation: 'middle',
          nameGap: 50,
          nameTextStyle: {fontWeight: '600', fontSize: 13},
          axisLabel: {color: '#666'},
          splitLine: {lineStyle: {color: '#f0f0f0'}}
        },
        series: [{
          type: 'scatter',
          symbolSize: 24,
          data: data,
          emphasis: {
            focus: 'series',
            label: {
              show: true,
              formatter: function(p){ return p.data.name; },
              position: 'top',
              fontWeight: '600',
              fontSize: 13
            },
            itemStyle: {
              shadowBlur: 10,
              shadowColor: 'rgba(0,0,0,0.3)'
            }
          }
        }],
        animationDuration: 800,
        animationEasing: 'cubicOut'
      });

      window.addEventListener('resize', function(){
        chart.resize();
      });
    })();
  })();
</script>

</body>
</html>