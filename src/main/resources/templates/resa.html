<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard Agronomica â€¢ Resa per Area</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

    <style>
        :root {
          --primary-green: #198754;
          --secondary-blue: #0d6efd;
          --light-bg: #f8f9fa;
          --danger-red: #dc3545;
          --warning-accessible: #e09400;
          --info-color: #0dcaf0;
          --purple: #6f42c1;
          --focus-ring: 0 0 0 0.25rem rgba(13, 110, 253, .25);
          --control-h: 44px;

          /* colori aree */
          --area-nord: #0d6efd;   /* blu */
          --area-centro: #D96D00; /* arancio */
          --area-sud: #10b981;    /* verde */

          /* colori per le CARD TOTALI */
          --pie-prod: #800080;   /* viola */
          --pie-surf: #B8860B;   /* ocra/sabbia scuro */
          --pie-resa: #6c757d;   /* grigio */
        }

        body {
          background-color: var(--light-bg);
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          padding-top: 70px;
        }
        .dashboard-card {
          border-radius: 1rem;
          box-shadow: 0 4px 10px rgba(0, 0, 0, .08);
          background: #fff;
          height: 100%
        }

        .header-bar {
          position: fixed; top: 0; left: 0; right: 0; z-index: 1040; background: #fff;
          box-shadow: 0 2px 4px rgba(0, 0, 0, .05); padding: .5rem 1rem;
          display: flex; align-items: center; gap: 1rem;
        }
        .header-logo { font-weight: 600; color: var(--primary-green); line-height: 1; margin: 0; }

        .filters-bar {
          display: flex; flex-wrap: nowrap; align-items: flex-end; gap: .5rem; width: 100%;
          overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: .25rem;
        }
        .filters-bar .form-group { flex: 1 1 0; min-width: 140px; }
        .filters-bar .form-select {
          height: var(--control-h); line-height: var(--control-h);
          padding: 0 2.25rem 0 .75rem; background-position: right .75rem center;
        }
        .filters-bar .btn-primary {
          height: var(--control-h); display: inline-flex; align-items: center; justify-content: center;
          padding: 0 14px; flex: 0 0 auto;
        }
        .form-select:focus, .btn:focus { box-shadow: var(--focus-ring); }
        .min-200 { min-width: 200px; }

        .section-header {
          padding-bottom: .25rem; margin-bottom: 1rem;
          border-bottom: 2px solid var(--secondary-blue);
        }
        .section-header.success-border { border-color: var(--primary-green); }

        .chartjs-like-legend { display: flex; gap: 24px; align-items: center; }
        .chartjs-like-legend .item { display: inline-flex; align-items: center; gap: 8px; font-size: .875rem; color: #6c757d; }
        .chartjs-like-legend .swatch { width: 36px; height: 12px; border-radius: 3px; border: 3px solid transparent; background-clip: padding-box; }
        .legend-nord .swatch { border-color: var(--area-nord); background-color: #0d6efd33; }
        .legend-centro .swatch { border-color: var(--area-centro); background-color: #fd7e1433; }
        .legend-sud .swatch { border-color: var(--area-sud); background-color: #10b98133; }

        .subtitle { color: #5f676d; font-size: .9375rem; line-height: 1.4; }
        .caption { color: var(--bs-tertiary-color, #8a8f94); font-size: .8125rem; }

        /* === STILI KPI BOX IMPORTATI E ADATTATI === */
        .kpi-box{
          padding: 1rem; border-radius: .5rem; border-left-width: 5px; border-left-style: solid;
        }
        .kpi-value { font-size: 2rem; font-weight: 700; }

        /* Colori personalizzati per le card KPI di questa pagina */
        .kpi-box.prod { background: #fdf5ff; border-left-color: var(--pie-prod); }
        .kpi-box.prod .kpi-value { color: var(--pie-prod); }
        .kpi-box.prod .kpi-icon { color: var(--pie-prod); }

        .kpi-box.surf { background: #fffaf0; border-left-color: var(--pie-surf); }
        .kpi-box.surf .kpi-value { color: var(--pie-surf); }
        .kpi-box.surf .kpi-icon { color: var(--pie-surf); }

        .kpi-box.resa { background: #f8f9fa; border-left-color: var(--pie-resa); }
        .kpi-box.resa .kpi-value { color: var(--pie-resa); }
        .kpi-box.resa .kpi-icon { color: var(--pie-resa); }
    </style>
</head>
<body>

<header class="header-bar">
    <a href="/" class="btn btn-outline-secondary" aria-label="Torna alla Dashboard"><i class="bi bi-arrow-left"></i></a>
    <h1 class="header-logo display-6 fs-4 mb-0">Resa per Area</h1>
    <a href="/export.csv" class="btn btn-outline-success ms-auto" aria-label="Esporta i dati filtrati in formato CSV">
        <i class="bi bi-download"></i> Export
    </a>
</header>

<div class="container-fluid py-4">

    <div class="dashboard-card p-3 mb-4">
        <form id="filterForm" action="/resa" method="get" class="filters-bar" role="group" aria-label="Filtri resa">
            <div class="form-group d-flex flex-column">
                <label class="form-label small text-muted mb-1" for="monthSel">Mese</label>
                <select id="monthSel" class="form-select">
                    <option th:each="m : ${#numbers.sequence(1,12)}"
                            th:value="${m}"
                            th:text="${#temporals.format(#temporals.create((from != null ? #temporals.year(from) : #temporals.year(#temporals.createNow())), m, 1),'MMMM')}"
                            th:selected="${from != null and #temporals.month(from) == m}">
                    </option>
                </select>
            </div>

            <div class="form-group d-flex flex-column">
                <label class="form-label small text-muted mb-1" for="yearSel">Anno</label>
                <select id="yearSel" class="form-select">
                    <option th:each="y : ${#numbers.sequence(2015, 2025)}"
                            th:value="${y}"
                            th:text="${y}"
                            th:selected="${from != null ? #temporals.year(from) == y : y == #temporals.year(#temporals.createNow())}">
                    </option>
                </select>
            </div>

            <div class="form-group d-flex flex-column min-200">
                <label class="form-label small text-muted mb-1" for="cropSel">Coltura</label>
                <select id="cropSel" name="crop" class="form-select">
                    <option value="">Tutte</option>
                    <option th:each="c : ${cropsList}" th:value="${c}" th:text="${c}" th:selected="${c == crop}"></option>
                </select>
            </div>

            <div class="form-group d-flex flex-column min-200">
                <label class="form-label small text-muted mb-1" for="areaSel">Area</label>
                <select id="areaSel" name="area" class="form-select">
                    <option value="">Tutte</option>
                    <option th:each="a : ${areasList}" th:value="${a}" th:text="${a}" th:selected="${a == area}"></option>
                </select>
            </div>

            <button type="submit" class="btn btn-primary">
                <i class="bi bi-funnel me-1"></i>Applica Filtri
            </button>

            <input type="hidden" id="from" name="from" th:value="${from != null ? #temporals.format(from,'yyyy-MM-dd') : ''}"/>
            <input type="hidden" id="to" name="to" th:value="${to != null ? #temporals.format(to,'yyyy-MM-dd') : ''}"/>
        </form>
    </div>

    <div class="row g-4 mb-4">
        <div class="col">
            <div class="kpi-box prod">
                <p class="small text-muted mb-1"><i class="bi bi-box-seam-fill kpi-icon"></i> PRODUZIONE TOTALE</p>
                <div class="d-flex align-items-baseline">
                    <span class="kpi-value" id="totalValueProd">-</span>
                    <span class="ms-2 text-muted fw-semibold">(t)</span>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="kpi-box surf">
                <p class="small text-muted mb-1"><i class="bi bi-rulers kpi-icon"></i> SUPERFICIE TOTALE</p>
                <div class="d-flex align-items-baseline">
                    <span class="kpi-value" id="totalValueSurf">-</span>
                    <span class="ms-2 text-muted fw-semibold">(ha)</span>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="kpi-box resa">
                <p class="small text-muted mb-1"><i class="bi bi-graph-up-arrow kpi-icon"></i> RESA MEDIA TOTALE</p>
                <div class="d-flex align-items-baseline">
                    <span class="kpi-value" id="totalValueResa">-</span>
                    <span class="ms-2 text-muted fw-semibold">(t/ha)</span>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-4">
        <div class="col-lg-7">
            <div class="dashboard-card p-4">
                <div class="d-flex justify-content-between align-items-center section-header success-border">
                    <h2 class="h6 mb-0 fw-bold text-success">Resa media per Area (t/ha)</h2>
                    <div class="chartjs-like-legend" aria-hidden="true">
                        <span class="item legend-nord"><span class="swatch"></span>Nord</span>
                        <span class="item legend-centro"><span class="swatch"></span>Centro</span>
                        <span class="item legend-sud"><span class="swatch"></span>Sud</span>
                    </div>
                </div>
                <p class="subtitle mb-3">
                    Confronto della <strong>resa media (t/ha)</strong> per area geografica nel periodo selezionato.
                </p>
                <div id="echResaByAreaChart" style="height: 380px;">
                    <span class="visually-hidden">Grafico a barre che mostra la resa media per area geografica.</span>
                </div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="dashboard-card p-4">
                <div class="d-flex justify-content-between align-items-center section-header success-border">
                    <h3 class="h6 mb-0 fw-bold text-success">Composizione Produzione (%)</h3>
                </div>
                <p class="subtitle mb-3">
                    Contributo percentuale di ciascuna area alla <strong>produzione totale</strong> in tonnellate.
                </p>
                <div id="echDonutYield" style="height: 380px;">
                    <span class="visually-hidden">Grafico ad anello sulla ripartizione percentuale della produzione.</span>
                </div>
            </div>
        </div>
    </div>
    <div class="dashboard-card p-4 mt-4">
        <h3 class="h6 mb-0 fw-bold text-success">Dettaglio dati selezionati
            <span class="badge bg-secondary ms-2" th:text="${crop != null ? crop : 'Tutte le Colture'}">Tutte le Colture</span>
        </h3>
        <div class="table-responsive mt-3">
            <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                <tr>
                    <th scope="col">Area</th>
                    <th scope="col" class="text-end">Produzione (t)</th>
                    <th scope="col" class="text-end">Superficie (ha)</th>
                    <th scope="col" class="text-end fw-bold">Resa (t/ha)</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="r : ${resaRows}">
                    <td th:text="${r.area}">Nord</td>
                    <td class="text-end" th:text="${#numbers.formatDecimal(r.yieldT,1,'POINT',2,'COMMA')}">0,00</td>
                    <td class="text-end" th:text="${#numbers.formatDecimal(r.surfaceHa,1,'POINT',2,'COMMA')}">0,00</td>
                    <td class="text-end fw-bold" th:text="${#numbers.formatDecimal(r.resa,1,'POINT',2,'COMMA')}">0,00</td>
                </tr>
                </tbody>
                <tfoot class="table-light">
                <tr>
                    <th scope="row">Totale</th>
                    <th class="text-end" th:text="${#numbers.formatDecimal(totalYieldT,1,'POINT',2,'COMMA')}">0,00</th>
                    <th class="text-end" th:text="${#numbers.formatDecimal(totalSurfaceHa,1,'POINT',2,'COMMA')}">0,00</th>
                    <th class="text-end fw-bold" th:text="${#numbers.formatDecimal(totalResa,1,'POINT',2,'COMMA')}">0,00</th>
                </tr>
                </tfoot>
            </table>
            <p class="caption mt-2">
                Nota: le cifre in tabella sono aggregate in base ai filtri e possono differire per arrotondamenti.
            </p>
        </div>
    </div>

    <footer class="text-center py-3 mt-5 border-top text-muted small">
        &copy; [[${#temporals.year(#temporals.createNow())}]] AgrItalia S.p.A. | Dashboard Agronomica
    </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    (function() {
      const monthSel = document.getElementById('monthSel');
      const yearSel  = document.getElementById('yearSel');
      const fromH    = document.getElementById('from');
      const toH      = document.getElementById('to');
      const form     = document.getElementById('filterForm');

      function pad2(n){ return n < 10 ? '0' + n : '' + n; }
      function lastDay(y,m){ return new Date(y, m, 0).getDate(); }

      function refreshRange(){
        const y = parseInt(yearSel.value || new Date().getFullYear(), 10);
        const m = parseInt(monthSel.value || (new Date().getMonth()+1), 10);
        const dEnd = lastDay(y, m);
        fromH.value = y + '-' + pad2(m) + '-01';
        toH.value   = y + '-' + pad2(m) + '-' + pad2(dEnd);
      }

      refreshRange();
      monthSel.addEventListener('change', refreshRange);
      yearSel.addEventListener('change',  refreshRange);
      form && form.addEventListener('submit', refreshRange);
    })();
</script>

<script th:inline="javascript">
    /*<![CDATA[*/
    function cssVar(n){const v=getComputedStyle(document.documentElement).getPropertyValue(n);return (v&&v.trim())||n;}
    const C_NORD=cssVar('--area-nord'),C_CENTRO=cssVar('--area-centro'),C_SUD=cssVar('--area-sud');

    function getAreaColor(name){const n=(''+(name||'')).toLowerCase();if(n.includes('nord'))return C_NORD;if(n.includes('centro'))return C_CENTRO;if(n.includes('sud'))return C_SUD;return C_NORD;}
    const nf2 = new Intl.NumberFormat('it-IT',{maximumFractionDigits:2,minimumFractionDigits:2});
    const nf0 = new Intl.NumberFormat('it-IT',{maximumFractionDigits:0});
    const nfCompact = new Intl.NumberFormat('it-IT',{notation:'compact',maximumFractionDigits:1});

    function toNum(v){if(v==null) return 0;if(typeof v==='number') return isFinite(v)?v:0;const s=String(v).trim().replace(/\./g,'').replace(',', '.');const n=Number(s);return isFinite(n)?n:0;}

    const yieldNordT     = /*[[${yieldNordT}]]*/ 0;
    const yieldCentroT   = /*[[${yieldCentroT}]]*/ 0;
    const yieldSudT      = /*[[${yieldSudT}]]*/ 0;
    const surfNordHa     = /*[[${surfNordHa}]]*/ 0;
    const surfCentroHa   = /*[[${surfCentroHa}]]*/ 0;
    const surfSudHa      = /*[[${surfSudHa}]]*/ 0;
    const totalYieldT    = /*[[${totalYieldT}]]*/ 0;
    const totalSurfaceHa = /*[[${totalSurfaceHa}]]*/ 0;
    const totalResa      = /*[[${totalResa}]]*/ 0;

    /* ===== Popolamento Card KPI ===== */
    (function() {
      document.getElementById('totalValueProd').textContent = nfCompact.format(toNum(totalYieldT));
      document.getElementById('totalValueSurf').textContent = nfCompact.format(toNum(totalSurfaceHa));
      document.getElementById('totalValueResa').textContent = nf2.format(toNum(totalResa));
    })();

    /* ===== Grafico a barre: Resa Media per Area ===== */
    (function() {
      const barChartEl = document.getElementById('echResaByAreaChart');
      if (!barChartEl) return;
      const myChart = echarts.init(barChartEl);

      const AREAS = ['Nord','Centro','Sud'];
      const resaByKey = {};
      const sNord = toNum(surfNordHa), yNord = toNum(yieldNordT);
      const sCentro = toNum(surfCentroHa), yCentro = toNum(yieldCentroT);
      const sSud = toNum(surfSudHa), ySud = toNum(yieldSudT);
      resaByKey.nord = (sNord > 0) ? (yNord / sNord) : 0;
      resaByKey.centro = (sCentro > 0) ? (yCentro / sCentro) : 0;
      resaByKey.sud = (sSud > 0) ? (ySud / sSud) : 0;
      const resaByArea=[resaByKey.nord, resaByKey.centro, resaByKey.sud];

      myChart.setOption({
        tooltip:{ trigger:'item', formatter:(p)=> `${p.name}<br/>Resa: <b>${nf2.format(p.value)}</b> t/ha` },
        legend:{show:false},
        grid:{top:'10%', bottom:'15%', left:'12%', right:'5%'},
        xAxis:{type:'category', data:AREAS},
        yAxis:{name:'Resa (t/ha)', axisLabel:{formatter:(v)=>nf2.format(v)}},
        series:[{
            type:'bar',
            data: resaByArea.map((v,i)=>({value:v,name:AREAS[i],itemStyle:{color:getAreaColor(AREAS[i])}})),
            label:{show:true, position:'top', formatter:(p)=>nf2.format(p.value)}
        }]
      });
      window.addEventListener('resize',()=>myChart.resize());
    })();

    /* ===== Grafico Donut: Composizione Produzione ===== */
    (function() {
      const donutEl = document.getElementById('echDonutYield');
      if (!donutEl) return;
      const donutChart = echarts.init(donutEl);

      const data = [
        { value: toNum(yieldNordT),   name: 'Nord',   itemStyle: { color: C_NORD } },
        { value: toNum(yieldCentroT), name: 'Centro', itemStyle: { color: C_CENTRO } },
        { value: toNum(yieldSudT),    name: 'Sud',    itemStyle: { color: C_SUD } }
      ].filter(d => d.value > 0);

      if (data.length === 0) {
        donutEl.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-muted">Nessun dato di produzione disponibile.</div>';
        return;
      }

      donutChart.setOption({
        tooltip: { trigger: 'item', formatter: (p) => `<b>${p.name}</b><br/>Produzione: ${nf0.format(p.value)} t (${p.percent}%)` },
        legend: { show: false },
        series: [{
          name: 'Produzione', type: 'pie', radius: ['45%', '70%'], center: ['50%', '50%'],
          avoidLabelOverlap: true,
          label: { show: true, position: 'outside', formatter: '{b}\n{d}%', fontSize: 14, color: '#495057' },
          labelLine: { show: true, length: 15, length2: 15 },
          emphasis: { label: { show: true, fontSize: 16, fontWeight: 'bold' } },
          data: data
        }]
      });
      window.addEventListener('resize', () => donutChart.resize());
    })();
    /*]]>*/
</script>

</body>
</html>