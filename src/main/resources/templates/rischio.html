<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Agronomica - Performance e Rischio</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --primary-green:#198754;
      --secondary-blue:#0d6efd;
      --light-bg:#f8f9fa;
      --danger-red:#dc3545;
      --warning-accessible:#e09400;
      --info-color:#0dcaf0;
      --purple:#6f42c1;
    }

    body{background-color:var(--light-bg);font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    .dashboard-card{border-radius:1rem;box-shadow:0 4px 10px rgba(0,0,0,.08);background:#fff;height:100%}
    .section-header{padding-bottom:.25rem;margin-bottom:1rem;border-bottom:2px solid var(--secondary-blue)}

    /* KPI */
    .kpi-box{background:#f0fdf4;padding:15px;border-radius:.5rem;border-left:5px solid var(--primary-green)}
    .kpi-box.blue   {background:#eef6ff;border-left-color:var(--secondary-blue)}
    .kpi-box.purple {background:#f7f2ff;border-left-color:var(--purple)}
    .kpi-box.info   {background:#e7fbff;border-left-color:var(--info-color)}
    .kpi-value{font-size:2rem;font-weight:700}

    /* Gauge rischio (CSS) */
    .risk-gauge{--risk:.37;--thumb:34px;--track-h:12px;--edge-offset:10px;position:relative;width:100%;padding:calc(var(--thumb)/2) 16px}
    .risk-track{height:var(--track-h);border-radius:9999px;background:linear-gradient(90deg,#2b8c2f 0%,#86c443 30%,#e7cd27 50%,#e09400 65%,#c13b16 85%,#8b1d13 100%);position:relative;box-shadow:inset 0 1px 2px rgba(0,0,0,.15),0 2px 8px rgba(0,0,0,.12)}
    .risk-thumb{position:absolute;top:50%;left:calc(max(var(--edge-offset),min(calc(var(--risk)*100%),calc(100% - var(--edge-offset)))));transform:translate(-50%,-50%);width:var(--thumb);height:var(--thumb);border-radius:50%;background:#fff;display:grid;place-items:center;box-shadow:0 2px 10px rgba(0,0,0,.18),0 0 0 3px rgba(255,255,255,.85)}
    .risk-value{font-weight:700;font-size:.9rem;color:#2f2f2f;line-height:1}
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center fw-bold text-primary" href="/">
      FLORO <span class="badge bg-success ms-2">AGRI-DASH</span>
    </a>
    <span class="navbar-text me-auto d-none d-lg-block">Monitoraggio del Settore Primario</span>
    <a href="/export.csv" class="btn btn-outline-success"><i class="bi bi-download"></i> Export</a>
  </div>
</nav>

<div class="container-fluid py-4">

  <!-- FILTRI: Mese + Anno + Coltura + Area con pulsante a destra -->
  <div class="dashboard-card p-3 mb-4">
    <form id="filterForm" action="/" method="get" class="row g-3 align-items-end">
      <div class="col-12">
        <label class="form-label medium text-muted">Ricerca avanzata</label>
      </div>

      <div class="col-6 col-md-3">
        <select id="monthSel" class="form-select">
          <option value="1"  th:selected="${from != null and #temporals.month(from) == 1 }">Gennaio</option>
          <option value="2"  th:selected="${from != null and #temporals.month(from) == 2 }">Febbraio</option>
          <option value="3"  th:selected="${from != null and #temporals.month(from) == 3 }">Marzo</option>
          <option value="4"  th:selected="${from != null and #temporals.month(from) == 4 }">Aprile</option>
          <option value="5"  th:selected="${from != null and #temporals.month(from) == 5 }">Maggio</option>
          <option value="6"  th:selected="${from != null and #temporals.month(from) == 6 }">Giugno</option>
          <option value="7"  th:selected="${from != null and #temporals.month(from) == 7 }">Luglio</option>
          <option value="8"  th:selected="${from != null and #temporals.month(from) == 8 }">Agosto</option>
          <option value="9"  th:selected="${from != null and #temporals.month(from) == 9 }">Settembre</option>
          <option value="10" th:selected="${from != null and #temporals.month(from) == 10}">Ottobre</option>
          <option value="11" th:selected="${from != null and #temporals.month(from) == 11}">Novembre</option>
          <option value="12" th:selected="${from != null and #temporals.month(from) == 12}">Dicembre</option>
        </select>
      </div>

      <div class="col-6 col-md-2">
        <select id="yearSel" class="form-select">
          <option th:each="y : ${#numbers.sequence(2015, 2025)}"
                  th:value="${y}" th:text="${y}"
                  th:selected="${from != null ? #temporals.year(from) == y : y == #temporals.year(#temporals.createNow())}">
            2025
          </option>
        </select>
      </div>

      <div class="col-12 col-md-3">
        <label for="cropSel" class="form-label small text-muted d-md-none">Coltura</label>
        <select id="cropSel" name="crop" class="form-select">
          <option value="">Tutte</option>
          <option th:each="c : ${cropsList != null ? cropsList : {'Grano duro','Mais','Olivo','Vite'}}"
                  th:value="${c}" th:text="${c}" th:selected="${c == crop}">
            Coltura
          </option>
        </select>
      </div>

      <div class="col-12 col-md-3">
        <label for="areaSel" class="form-label small text-muted d-md-none">Area</label>
        <select id="areaSel" name="area" class="form-select">
          <option value="">Tutte</option>
          <option th:each="a : ${areasList != null ? areasList : {'Nord','Centro','Sud'}}"
                  th:value="${a}" th:text="${a}" th:selected="${a == area}">
            Area
          </option>
        </select>
      </div>

      <!-- Bottone allineato a destra della riga -->
      <div class="col-12 col-md-auto ms-md-auto d-grid">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-funnel"></i> Applica Filtri
        </button>
      </div>

      <!-- Hidden per il controller -->
      <input type="hidden" id="from" name="from" th:value="${#temporals.format(from,'yyyy-MM-dd')}"/>
      <input type="hidden" id="to"   name="to"   th:value="${#temporals.format(to,'yyyy-MM-dd')}"/>
    </form>
  </div>

  <!-- KPI -->
  <div class="row g-4 mb-4 row-cols-1 row-cols-md-2 row-cols-lg-4 row-cols-xl-5">
    <div class="col">
      <div class="kpi-box">
        <p class="small text-muted mb-1"><i class="bi bi-bar-chart-line-fill text-success"></i> RESA MEDIA</p>
        <div class="d-flex align-items-center">
          <span class="kpi-value text-success" th:text="${#numbers.formatDecimal(avgYieldHa,1,'POINT',2,'COMMA')}">0,00</span>
          <span class="ms-2 text-muted">t/ha</span>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="kpi-box blue">
        <p class="small text-muted mb-1"><i class="bi bi-water text-primary"></i> EFFICIENZA IDRICA</p>
        <div class="d-flex align-items-center">
          <span class="kpi-value text-primary" th:text="${#numbers.formatDecimal(avgEff,1,'POINT',2,'COMMA')}">0,00</span>
          <span class="ms-2 text-muted">Kg/m³</span>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="kpi-box purple">
        <p class="small text-muted mb-1"><i class="bi bi-cash-coin" style="color:#6f42c1"></i> COSTO UNITARIO</p>
        <div class="d-flex align-items-center">
          <span class="kpi-value" style="color:#6f42c1" th:text="${#numbers.formatDecimal(avgCost,1,'POINT',2,'COMMA')}">0,00</span>
          <span class="ms-2 text-muted">€/t</span>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="kpi-box info">
        <p class="small text-muted mb-1"><i class="bi bi-graph-up-arrow text-info"></i> MARGINE UNITARIO</p>
        <div class="d-flex align-items-center">
          <span class="kpi-value text-info" th:text="${#numbers.formatDecimal(avgMargin,1,'POINT',2,'COMMA')}">0,00</span>
          <span class="ms-2 text-muted">€/t</span>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="kpi-box" th:with="risk=${avgRisk}">
        <p class="small text-muted mb-1"><i class="bi bi-exclamation-triangle-fill text-warning"></i> RISCHIO CLIMATICO</p>
        <div class="d-flex align-items-center">
          <span class="kpi-value" th:text="${#numbers.formatDecimal(risk,1,'POINT',2,'COMMA')}">0,00</span>
          <span class="ms-2 text-muted">Indice (0-1)</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Resa multi-asse + Efficienza -->
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="dashboard-card p-4">
        <div class="d-flex justify-content-between align-items-center section-header">
          <h2 class="h6 mb-0 fw-bold text-primary">Andamento Resa (multi-asse)</h2>
          <span class="badge bg-secondary" th:text="${crop != null ? crop : 'Tutte le Colture'}">Tutte le Colture</span>
        </div>
        <div style="height:320px"><canvas id="yieldChartMultiAxis" aria-label="Andamento resa multi-asse"></canvas></div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="dashboard-card p-4">
        <div class="d-flex justify-content-between align-items-center section-header" style="border-color:var(--primary-green)">
          <h2 class="h6 mb-0 fw-bold text-success">Efficienza Idrica (Tachimetro)</h2>
          <a href="/risorse" class="btn btn-sm btn-outline-success">Vai al dettaglio →</a>
        </div>
        <p class="h5 fw-bold text-primary" th:text="${#numbers.formatDecimal(avgEff,1,'POINT',2,'COMMA')} + ' Kg/m³'">0,00 Kg/m³</p>
        <div style="height:260px"><canvas id="effTach"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Costo & Margine affiancati -->
  <div class="row g-4 mt-4">
    <div class="col-lg-6">
      <div class="dashboard-card p-4">
        <div class="d-flex justify-content-between align-items-center section-header" style="border-color:#6f42c1">
          <h2 class="h6 mb-0" style="color:#6f42c1">Costo vs Margine (€/t)</h2>
        </div>
        <div style="height:260px"><canvas id="costMarginStacked"></canvas></div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="dashboard-card p-4">
        <div class="d-flex justify-content-between align-items-center section-header" style="border-color:var(--info-color)">
          <h2 class="h6 mb-0 text-info">Prezzo → Costi → Margine</h2>
        </div>
        <div style="height:260px"><canvas id="marginWaterfall"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Rischio Climatico (gauge CSS) -->
  <div class="row g-4 mt-4">
    <div class="col-12">
      <div class="dashboard-card p-4">
        <div class="d-flex justify-content-between align-items-center section-header" style="border-color:var(--warning-accessible)">
          <h2 class="h6 mb-0 fw-bold" style="color:var(--warning-accessible)">Rischio Climatico</h2>
          <a href="/rischio" class="btn btn-sm btn-outline-warning">Analisi Mappa Rischio →</a>
        </div>

        <p class="text-muted small mb-3">
          Indice medio nel periodo selezionato:
          <span class="fw-bold" th:text="${#numbers.formatDecimal(avgRisk,1,'POINT',2,'COMMA')}">0,00</span>
          (0 = basso, 1 = alto).
        </p>

        <div class="risk-gauge"
             role="progressbar" aria-label="Indice di rischio climatico"
             aria-valuemin="0" aria-valuemax="1"
             th:attr="aria-valuenow=${avgRisk}"
             th:style="'--risk:' + ${avgRisk}">
          <div class="risk-track"></div>
          <div class="risk-thumb"><span class="risk-value" th:text="${#numbers.formatDecimal(avgRisk,1,'POINT',2,'COMMA')}">0,00</span></div>
        </div>

        <div class="d-flex justify-content-around text-center small mt-3">
          <span class="text-success">Basso (&lt; 0,4)</span>
          <span style="color:var(--warning-accessible)">Medio (0,4 - 0,7)</span>
          <span class="text-danger">Alto (&gt; 0,7)</span>
        </div>
      </div>
    </div>
  </div>

</div><!-- /container -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Script filtri: calcola hidden from/to dal Mese/Anno -->
<script>
  (function(){
    const monthSel = document.getElementById('monthSel');
    const yearSel  = document.getElementById('yearSel');
    const fromH    = document.getElementById('from');
    const toH      = document.getElementById('to');
    const form     = document.getElementById('filterForm');

    function pad2(n){ return n<10 ? '0'+n : ''+n; }
    function lastDay(y,m){ return new Date(y, m, 0).getDate(); } // m: 1..12

    function refreshHidden(){
      var y = parseInt(yearSel.value,10);
      var m = parseInt(monthSel.value,10);
      var dEnd = lastDay(y,m);
      fromH.value = y + '-' + pad2(m) + '-01';
      toH.value   = y + '-' + pad2(m) + '-' + pad2(dEnd);
    }

    (function init(){
      var haveFrom = fromH && fromH.value && fromH.value.length === 10;
      if (haveFrom){
        var p = fromH.value.split('-');
        if (p.length === 3){ monthSel.value = String(parseInt(p[1],10)); yearSel.value = p[0]; }
      } else {
        var today = new Date();
        monthSel.value = (today.getMonth()+1).toString();
        yearSel.value  = today.getFullYear().toString();
      }
      refreshHidden();
    })();

    monthSel.addEventListener('change', refreshHidden);
    yearSel.addEventListener('change',  refreshHidden);
    form.addEventListener('submit',      refreshHidden);
  })();
</script>

<!-- Grafici -->
<script th:inline="javascript">
  /*<![CDATA[*/
    const labels      = [[${labels}]];
    const yieldsNord  = [[${yieldsNord}]];
    const yieldsCentro= [[${yieldsCentro}]];
    const yieldsSud   = [[${yieldsSud}]];
    const selectedArea= /*[[${area}]]*/ null;

    const avgEff     = /*[[${avgEff}]]*/ 0;
    const effMax     = /*[[${effMaxScale}]]*/ 50;
    const avgCost    = /*[[${avgCost}]]*/ 0;
    const avgMargin  = /*[[${avgMargin}]]*/ 0;
    const unitPrice  = avgCost + avgMargin;

    // === Andamento Resa (Multi-Axis Line) ===
    (function(){
      const el = document.getElementById('yieldChartMultiAxis'); if(!el) return;

      // Costruisco datasets in base al filtro area
      const allSets = [
        {
          label: 'Nord',
          data: yieldsNord,
          yAxisID: 'y',
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13,110,253,0.1)',
          tension: 0,           // linee spigolose
          pointRadius: 0
        },
        {
          label: 'Centro',
          data: yieldsCentro,
          yAxisID: 'y',
          borderColor: '#198754',
          backgroundColor: 'rgba(25,135,84,0.1)',
          tension: 0,
          pointRadius: 0
        },
        {
          label: 'Sud',
          data: yieldsSud,
          yAxisID: 'y1',        // seconda scala a destra
          borderColor: '#fd7e14',
          backgroundColor: 'rgba(253,126,20,0.1)',
          tension: 0,
          pointRadius: 0
        }
      ];

      let datasets;
      switch ((selectedArea || '').toLowerCase()) {
        case 'nord':   datasets = [allSets[0]]; break;
        case 'centro': datasets = [allSets[1]]; break;
        case 'sud':    datasets = [allSets[2]]; break;
        default:       datasets = allSets;
      }

      new Chart(el.getContext('2d'), {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          stacked: false,
          plugins: { legend: { position: 'bottom' } },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: true, text: 'Resa (T)' },
              grid: { drawOnChartArea: true },
              ticks: { precision: 0 }
            },
            y1: {
              type: 'linear',
              display: datasets.length > 1,  // mostra la destra solo se serve
              position: 'right',
              title: { display: true, text: 'Resa (T) – scala 2' },
              grid: { drawOnChartArea: false }, // niente griglia sopra la sinistra
              ticks: { precision: 0 }
            },
            x: { type:'category' }
          },
          elements: { line: { borderWidth: 2, cubicInterpolationMode: 'default' } }
        }
      });
    })();

    // === Tachimetro Efficienza (doughnut + ago) ===
    (function(){
      const el = document.getElementById('effTach'); if(!el) return;
      const z1 = 0.50, z2 = 0.80;

      const needle = {
        id:'needle',
        afterDraw(chart){
          const m = chart.getDatasetMeta(0);
          if(!m?.data?.length) return;
          const ctx = chart.ctx;
          const cx = m.data[0].x, cy = m.data[0].y;
          const outer = m.data[0].outerRadius, inner = m.data[0].innerRadius;

          const t = Math.max(0, Math.min(avgEff/effMax, 1));
          const ang = (-0.5 + t) * Math.PI; // -90°..+90°
          const len = (outer + inner)/2;
          const x2 = cx + len * Math.cos(ang);
          const y2 = cy + len * Math.sin(ang);

          ctx.save();
          ctx.beginPath(); ctx.rect(0,0,chart.width,chart.height); ctx.clip();
          ctx.lineWidth = 3; ctx.strokeStyle = '#333'; ctx.fillStyle = '#333';
          ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(x2, y2); ctx.stroke();
          ctx.beginPath(); ctx.arc(cx, cy, 6, 0, 2*Math.PI); ctx.fill();
          ctx.restore();
        }
      };

      new Chart(el.getContext('2d'), {
        type:'doughnut',
        data:{
          labels:['Bassa','Media','Alta'],
          datasets:[{
            data:[z1,(z2 - z1),(1 - z2)],
            backgroundColor:['#c13b16','#e7cd27','#2b8c2f'],
            borderWidth:0, cutout:'80%'
          }]
        },
        options:{rotation:-90, circumference:180, responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}, tooltip:{enabled:true}}},
        plugins:[needle]
      });
    })();

    // === Costo vs Margine (stacked orizzontale) ===
    (function(){
      const el = document.getElementById('costMarginStacked'); if(!el) return;
      new Chart(el.getContext('2d'), {
        type:'bar',
        data:{
          labels:['Prezzo unitario'],
          datasets:[
            {label:'Costo €/t',   data:[avgCost],   backgroundColor:'#ef4444', stack:'s'},
            {label:'Margine €/t', data:[avgMargin], backgroundColor:'#10b981', stack:'s'}
          ]
        },
        options:{
          indexAxis:'y', responsive:true, maintainAspectRatio:false,
          plugins:{legend:{position:'bottom'}, tooltip:{callbacks:{label:c=>`${c.dataset.label}: € ${(+c.raw).toFixed(2)}`}}},
          scales:{x:{stacked:true, beginAtZero:true, title:{display:true,text:'€ / t'}}, y:{stacked:true}}
        }
      });
    })();

    // === Waterfall semplice ===
    (function(){
      const el = document.getElementById('marginWaterfall'); if(!el) return;
      const wfLabels = ['Prezzo', '− Costi', 'Margine'];
      const wfValues = [unitPrice, -avgCost, avgMargin];
      new Chart(el.getContext('2d'), {
        type:'bar',
        data:{labels:wfLabels, datasets:[{data:wfValues, backgroundColor:(ctx)=> ctx.raw>=0 ? '#10b981' : '#ef4444', borderWidth:0}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`${c.label}: € ${Math.abs(+c.raw).toFixed(2)}`}}},scales:{y:{beginAtZero:true,title:{display:true,text:'€ / t'}}}}
      });
    })();
  /*]]>*/
</script>

</body>
</html>
