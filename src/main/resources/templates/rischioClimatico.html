<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Agronomica â€¢ Rischio Climatico</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" th:href="@{/css/common.css}"/>
  <link rel="stylesheet" th:href="@{/css/rischioClimatico.css}"/>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>

<header class="header-bar">
  <a th:href="@{'/'}" class="btn btn-outline-secondary btn-back" aria-label="Torna alla Dashboard">
    <i class="bi bi-arrow-left"></i>
  </a>
  <h1 class="header-logo display-6 fs-4 mb-0">
    <i class="bi bi-cloud-lightning-fill me-2" style="color:var(--warning-accessible)"></i>
    Rischio Climatico
  </h1>
  <a href="#" id="exportLink" class="btn btn-outline-success ms-auto"
     aria-label="Esporta i dati filtrati in formato CSV">
    <i class="bi bi-download me-1"></i>
    <span class="d-none d-sm-inline">Export</span>
  </a>
</header>

<div class="container-fluid py-4">

  <div class="dashboard-card p-3 mb-4">
    <form id="filterForm" th:action="@{/rischioClimatico}" method="get"
          class="filters-bar" role="group" aria-label="Filtri rischio climatico">
      <div class="form-group">
        <label class="form-label small text-muted mb-1 fw-semibold" for="monthSel">Mese</label>
        <select id="monthSel" class="form-select" aria-label="Seleziona mese">
          <option value="1" th:selected="${from!=null and #temporals.month(from)==1 }">Gennaio</option>
          <option value="2" th:selected="${from!=null and #temporals.month(from)==2 }">Febbraio</option>
          <option value="3" th:selected="${from!=null and #temporals.month(from)==3 }">Marzo</option>
          <option value="4" th:selected="${from!=null and #temporals.month(from)==4 }">Aprile</option>
          <option value="5" th:selected="${from!=null and #temporals.month(from)==5 }">Maggio</option>
          <option value="6" th:selected="${from!=null and #temporals.month(from)==6 }">Giugno</option>
          <option value="7" th:selected="${from!=null and #temporals.month(from)==7 }">Luglio</option>
          <option value="8" th:selected="${from!=null and #temporals.month(from)==8 }">Agosto</option>
          <option value="9" th:selected="${from!=null and #temporals.month(from)==9 }">Settembre</option>
          <option value="10" th:selected="${from!=null and #temporals.month(from)==10}">Ottobre</option>
          <option value="11" th:selected="${from!=null and #temporals.month(from)==11}">Novembre</option>
          <option value="12" th:selected="${from!=null and #temporals.month(from)==12}">Dicembre</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label small text-muted mb-1 fw-semibold" for="yearSel">Anno</label>
        <select id="yearSel" class="form-select" aria-label="Seleziona anno">
          <option th:each="y:${#numbers.sequence(2015,2025)}"
                  th:value="${y}"
                  th:text="${y}"
                  th:selected="${from!=null ? #temporals.year(from)==y : y==#temporals.year(#temporals.createNow())}">
            2025
          </option>
        </select>
      </div>
      <div class="form-group" style="min-width:180px">
        <label class="form-label small text-muted mb-1 fw-semibold" for="cropSel">Coltura</label>
        <select id="cropSel" name="crop" class="form-select" aria-label="Seleziona coltura">
          <option value="">Tutte le colture</option>
          <option th:each="c:${cropsList}" th:value="${c}" th:text="${c}"
                  th:selected="${c==crop}">Coltura
          </option>
        </select>
      </div>
      <div class="form-group" style="min-width:180px">
        <label class="form-label small text-muted mb-1 fw-semibold" for="areaSel">Area</label>
        <select id="areaSel" name="area" class="form-select" aria-label="Seleziona area">
          <option value="">Tutte le aree</option>
          <option th:each="a:${areasList}" th:value="${a}" th:text="${a}"
                  th:selected="${a==area}">Area
          </option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-funnel me-2"></i>
        <span>Applica</span>
      </button>
      <input type="hidden" id="from" name="startDate"
             th:value="${from!=null ? #temporals.format(from,'yyyy-MM-dd') : ''}"/>
      <input type="hidden" id="to" name="endDate"
             th:value="${to!=null ? #temporals.format(to,'yyyy-MM-dd') : ''}"/>
    </form>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-12 col-md-4">
      <div class="kpi-box risk">
        <p class="small text-muted mb-2 fw-semibold">
          <i class="bi bi-exclamation-triangle-fill kpi-icon" style="color: var(--kpi-risk-border)"></i>
          INDICE DI RISCHIO
        </p>
        <div class="d-flex align-items-baseline">
          <span class="kpi-value" style="color: var(--kpi-risk-border)"
                th:text="${#numbers.formatDecimal(totalAvgRiskIndex,1,'POINT',2,'COMMA')}">0,00</span>
          <span class="ms-2 text-muted fw-medium">(0-1)</span>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="kpi-box temp">
        <p class="small text-muted mb-2 fw-semibold">
          <i class="bi bi-thermometer-half kpi-icon" style="color: var(--kpi-temp-border)"></i>
          RISCHIO TERMICO
        </p>
        <div class="d-flex align-items-baseline">
          <span class="kpi-value" style="color: var(--kpi-temp-border)"
                th:text="${#numbers.formatDecimal(totalAvgRiskTemp,1,'POINT',2,'COMMA')}">0,00</span>
          <span class="ms-2 text-muted fw-medium">(0-1)</span>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="kpi-box water">
        <p class="small text-muted mb-2 fw-semibold">
          <i class="bi bi-cloud-drizzle-fill kpi-icon" style="color: var(--kpi-water-border)"></i>
          STRESS IDRICO
        </p>
        <div class="d-flex align-items-baseline">
          <span class="kpi-value" style="color: var(--kpi-water-border)"
                th:text="${#numbers.formatDecimal(totalAvgRiskWater,1,'POINT',2,'COMMA')}">0,00</span>
          <span class="ms-2 text-muted fw-medium">(0-1)</span>
        </div>
      </div>
    </div>
  </div>

  <div class="dashboard-card p-4 mb-4">
    <div class="row g-4">
      <div class="col-lg-7">
        <div class="section-header warning-border header-line">
          <div class="left">
            <h2 class="h6 mb-0 fw-bold" style="color: var(--warning-accessible)">
              <i class="bi bi-graph-up me-2"></i>
              Andamento Storico del Rischio Climatico
            </h2>
            <span class="badge" style="background-color: rgba(224, 148, 0, 0.15); color: #b87500"
                  th:text="${crop != null && !#strings.isEmpty(crop) ? crop : 'Tutte le Colture'}">
              Tutte le Colture
            </span>
          </div>
        </div>
        <p class="subtitle mb-3">
          Evoluzione dell'<strong>indice di rischio climatico</strong> (0=basso, 1=alto)
          per area geografica nel corso degli anni.
        </p>
        <div class="chart-container">
          <canvas id="riskAnnualTrend" role="img"
                  aria-label="Grafico a linee sull'andamento dell'indice di rischio negli anni."></canvas>
        </div>
      </div>
      <div class="col-lg-5">
        <div class="section-header primary-border header-line">
          <div class="left">
            <h3 class="h6 mb-0 fw-bold text-primary">
              <i class="bi bi-radar me-2"></i>
              Profilo di Rischio per Area
            </h3>
            <span class="badge bg-primary bg-opacity-10 text-primary"
                  th:text="${crop != null && !#strings.isEmpty(crop) ? crop : 'Tutte le Colture'}">
              Tutte le Colture
            </span>
          </div>
        </div>
        <p class="subtitle mb-3">
          Scomposizione del rischio nei suoi <strong>fattori principali</strong>
          per ciascuna area nel periodo selezionato.
        </p>
        <div id="echRadarRiskProfile" class="chart-container"
             role="img" aria-label="Grafico a radar sui fattori di rischio per area."></div>
      </div>
    </div>
  </div>

  <div class="dashboard-card p-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <h3 class="h6 mb-0 fw-bold" style="color: var(--warning-accessible)">
        <i class="bi bi-table me-2"></i>
        Dettaglio Rischio per Fattore
      </h3>
      <span class="badge bg-secondary"
            th:text="${crop!=null and !#strings.isEmpty(crop) ? crop : 'Tutte le colture'}">
        Tutte le colture
      </span>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
        <tr>
          <th scope="col">Area</th>
          <th scope="col" class="text-end">Indice Rischio Totale</th>
          <th scope="col" class="text-end">Rischio Termico</th>
          <th scope="col" class="text-end">Stress Idrico</th>
          <th scope="col" class="text-end">Rischio Gelo</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="r:${rischioRows}">
          <td>
            <span class="fw-semibold" th:text="${r.area}">Area</span>
          </td>
          <td class="text-end fw-bold"
              th:text="${#numbers.formatDecimal(r.riskIndex,1,'POINT',2,'COMMA')}">0,00
          </td>
          <td class="text-end"
              th:text="${#numbers.formatDecimal(r.riskTemp,1,'POINT',2,'COMMA')}">0,00
          </td>
          <td class="text-end"
              th:text="${#numbers.formatDecimal(r.riskWater,1,'POINT',2,'COMMA')}">0,00
          </td>
          <td class="text-end"
              th:text="${#numbers.formatDecimal(r.riskFrost,1,'POINT',2,'COMMA')}">0,00
          </td>
        </tr>
        </tbody>
      </table>
      <p class="caption mt-3">
        <i class="bi bi-info-circle me-1"></i>
        I valori in tabella rappresentano le medie del periodo filtrato (mese/anno selezionati).
      </p>
    </div>
  </div>

  <footer class="text-center py-4 mt-5 border-top">
    <p class="text-muted small mb-0">
      &copy; <span th:text="${#temporals.year(#temporals.createNow())}">2025</span>
      AgrItalia S.p.A. | Dashboard Agronomica
    </p>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/common.js}"></script>

<script th:inline="javascript">
  window.rischioData = {
    years: [[${years}]],
    annualRiskNord: [[${annualRiskNord}]],
    annualRiskCentro: [[${annualRiskCentro}]],
    annualRiskSud: [[${annualRiskSud}]],
    area: [[${area}]],
    riskTempNord: [[${riskTempNord}]],
    riskTempCentro: [[${riskTempCentro}]],
    riskTempSud: [[${riskTempSud}]],
    riskWaterNord: [[${riskWaterNord}]],
    riskWaterCentro: [[${riskWaterCentro}]],
    riskWaterSud: [[${riskWaterSud}]],
    riskFrostNord: [[${riskFrostNord}]],
    riskFrostCentro: [[${riskFrostCentro}]],
    riskFrostSud: [[${riskFrostSud}]]
  };
</script>

<script th:src="@{/js/rischioClimatico.js}"></script>

</body>
</html>