<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-italia@2.11.2/dist/css/bootstrap-italia.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<link rel="stylesheet" th:href="@{/css/styles.css}">

<main-content th:fragment="main-content">

  <div class="row mb-4">
    <div class="col-12">
      <p class="text-muted">
        Analisi focalizzata sull'efficienza idrica (Kg di prodotto per m³ di acqua) e sui costi.
        L'obiettivo è identificare le colture e le zone con maggiore sostenibilità nell'uso delle risorse.
      </p>
    </div>
  </div>

  <div th:replace="~{fragments/filters :: filter-toolbar(
        ${filterFrom}, ${filterTo}, ${filterCrop}, ${filterArea}, ${cropsList}, ${areasList}, ${startDate2024}, ${endDate2024}
    )}">Toolbar Filtri</div>

  <div th:replace="~{fragments/cards :: kpi-cards(
        ${avgYieldHa}, ${avgEff}, ${avgCost}, ${avgMargin}, ${avgRisk}, ${avgIpa}, ${filterCrop}, ${filterArea}
    )}">KPI Cards</div>

  <hr class="section-separator"/>

  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card p-3 h-100">
        <h3 class="h6 fw-bold card-title">Efficienza Idrica Media per Coltura (Kg/m³)</h3>
        <div class="chart-container">
          <canvas id="effByCrop" role="img" aria-label="Grafico a barre dell'Efficienza Idrica per Coltura"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-6 mb-4">
      <div class="card p-3 h-100">
        <h3 class="h6 fw-bold card-title">Costo Unitario Medio per Coltura (€/t)</h3>
        <div class="chart-container">
          <canvas id="costByCrop" role="img" aria-label="Grafico a barre del Costo Unitario per Coltura"></canvas>
        </div>
      </div>
    </div>
  </div>

  <hr class="section-separator"/>

  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card p-3 h-100">
        <h3 class="h6 fw-bold card-title">Margine Unitario Medio per Zona (€/t)</h3>
        <div class="chart-container">
          <canvas id="marginByArea" role="img" aria-label="Grafico a barre del Margine Unitario per Zona"></canvas>
        </div>
      </div>
    </div>
  </div>

</main-content>

<th:block th:fragment="page-scripts">
  <script th:inline="javascript">
    /*<![CDATA[*/
    const avgEffByCrop = /*[[${avgEffByCrop}]]*/ {};
    const avgCostByCrop = /*[[${avgCostByCrop}]]*/ {};
    const avgMarginByArea = /*[[${avgMarginByArea}]]*/ {};
    const cropsList = /*[[${cropsList}]]*/ [];
    const areasList = /*[[${areasList}]]*/ [];
    const isEmpty = /*[[${isEmpty}]]*/ false;

    if (!isEmpty) {
        // 1. Efficienza Idrica per Coltura (Bar)
        const cropEffLabels = cropsList.filter(c => avgEffByCrop[c] != null);
        const cropEffData = cropEffLabels.map(c => avgEffByCrop[c]);

        new Chart(document.getElementById('effByCrop'), {
            type: 'bar',
            data: {
                labels: cropEffLabels,
                datasets: [{
                    label: 'Eff. Idrica (Kg/m³)',
                    data: cropEffData,
                    backgroundColor: '#0087a3',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { position: 'bottom' } }
            }
        });

        // 2. Costo Unitario per Coltura (Bar)
        const cropCostLabels = cropsList.filter(c => avgCostByCrop[c] != null);
        const cropCostData = cropCostLabels.map(c => avgCostByCrop[c]);

        new Chart(document.getElementById('costByCrop'), {
            type: 'bar',
            data: {
                labels: cropCostLabels,
                datasets: [{
                    label: 'Costo Unitario (€/t)',
                    data: cropCostData,
                    backgroundColor: '#e3000f',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { position: 'bottom' } }
            }
        });

        // 3. Margine Unitario per Zona (Bar)
        const areaMarginLabels = areasList.filter(a => avgMarginByArea[a] != null);
        const areaMarginData = areaMarginLabels.map(a => avgMarginByArea[a]);

        new Chart(document.getElementById('marginByArea'), {
            type: 'bar',
            data: {
                labels: areaMarginLabels,
                datasets: [{
                    label: 'Margine (€/t)',
                    data: areaMarginData,
                    backgroundColor: '#0066cc',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }
    /*]]>*/
  </script>
</th:block>
</html>