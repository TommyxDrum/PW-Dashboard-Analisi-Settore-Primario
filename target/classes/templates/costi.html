<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AgrItalia • Costi di produzione</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" th:href="@{/css/common.css}"/>
  <link rel="stylesheet" th:href="@{/css/costi.css}"/>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>

<header class="header-bar">
  <a href="/" class="btn btn-outline-secondary btn-back" aria-label="Torna alla Dashboard">
    <i class="bi bi-arrow-left"></i>
  </a>
  <h1 class="header-logo display-6 fs-4 mb-0">
    <i class="bi bi-tag-fill me-2" style="color:var(--purple)"></i>
    Costi di produzione
  </h1>
  <a href="#" id="exportLink" class="btn btn-outline-success ms-auto" aria-label="Esporta dati in CSV">
    <i class="bi bi-download me-1"></i>
    <span class="d-none d-sm-inline">Export</span>
  </a>
</header>

<div class="container-fluid py-4">

  <div class="dashboard-card p-3 mb-4">
    <form id="filterForm" action="/costi" method="get" class="filters-bar"
          role="group" aria-label="Filtri analisi costi">
      <div class="form-group">
        <label class="form-label small text-muted mb-1 fw-semibold" for="monthSel">Mese</label>
        <select id="monthSel" class="form-select" aria-label="Seleziona mese">
          <option value="1"  th:selected="${from!=null and #temporals.month(from)==1 }">Gennaio</option>
          <option value="2"  th:selected="${from!=null and #temporals.month(from)==2 }">Febbraio</option>
          <option value="3"  th:selected="${from!=null and #temporals.month(from)==3 }">Marzo</option>
          <option value="4"  th:selected="${from!=null and #temporals.month(from)==4 }">Aprile</option>
          <option value="5"  th:selected="${from!=null and #temporals.month(from)==5 }">Maggio</option>
          <option value="6"  th:selected="${from!=null and #temporals.month(from)==6 }">Giugno</option>
          <option value="7"  th:selected="${from!=null and #temporals.month(from)==7 }">Luglio</option>
          <option value="8"  th:selected="${from!=null and #temporals.month(from)==8 }">Agosto</option>
          <option value="9"  th:selected="${from!=null and #temporals.month(from)==9 }">Settembre</option>
          <option value="10" th:selected="${from!=null and #temporals.month(from)==10}">Ottobre</option>
          <option value="11" th:selected="${from!=null and #temporals.month(from)==11}">Novembre</option>
          <option value="12" th:selected="${from!=null and #temporals.month(from)==12}">Dicembre</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label small text-muted mb-1 fw-semibold" for="yearSel">Anno</label>
        <select id="yearSel" class="form-select" aria-label="Seleziona anno">
          <option th:each="y:${#numbers.sequence(2015,2025)}"
                  th:value="${y}"
                  th:text="${y}"
                  th:selected="${from!=null ? #temporals.year(from)==y : y==#temporals.year(#temporals.createNow())}">
            2025
          </option>
        </select>
      </div>
      <div class="form-group" style="min-width:180px">
        <label class="form-label small text-muted mb-1 fw-semibold" for="cropSel">Coltura</label>
        <select id="cropSel" name="crop" class="form-select" aria-label="Seleziona coltura">
          <option value="">Tutte le colture</option>
          <option th:each="c:${cropsList}" th:value="${c}" th:text="${c}"
                  th:selected="${c==crop}">Coltura</option>
        </select>
      </div>
      <div class="form-group" style="min-width:180px">
        <label class="form-label small text-muted mb-1 fw-semibold" for="areaSel">Area</label>
        <select id="areaSel" name="area" class="form-select" aria-label="Seleziona area">
          <option value="">Tutte le aree</option>
          <option th:each="a:${areasList}" th:value="${a}" th:text="${a}"
                  th:selected="${a==area}">Area</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-funnel me-2"></i>
        <span>Applica</span>
      </button>
      <input type="hidden" id="from" name="startDate"
             th:value="${from!=null ? #temporals.format(from,'yyyy-MM-dd') : ''}"/>
      <input type="hidden" id="to" name="endDate"
             th:value="${to!=null ? #temporals.format(to,'yyyy-MM-dd') : ''}"/>
    </form>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-12 col-md-4">
      <div class="kpi-box cost">
        <p class="small text-muted mb-2 fw-semibold">
          <i class="bi bi-tag-fill kpi-icon" style="color:var(--kpi-cost-border)"></i>
          COSTO UNITARIO MEDIO
        </p>
        <div class="d-flex align-items-baseline">
          <span class="kpi-value" style="color:var(--kpi-cost-border)"
                th:text="${#numbers.formatDecimal(totalAvgCost,1,'POINT',2,'COMMA')}">0,00</span>
          <span class="ms-2 text-muted fw-medium">€/t</span>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="kpi-box labor">
        <p class="small text-muted mb-2 fw-semibold">
          <i class="bi bi-person-fill kpi-icon" style="color:var(--kpi-labor-border)"></i>
          COSTO MANODOPERA
        </p>
        <div class="d-flex align-items-baseline">
          <span class="kpi-value" style="color:var(--kpi-labor-border)"
                th:text="${#numbers.formatDecimal(totalAvgCostLabor,1,'POINT',2,'COMMA')}">0,00</span>
          <span class="ms-2 text-muted fw-medium">€/t</span>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="kpi-box materials">
        <p class="small text-muted mb-2 fw-semibold">
          <i class="bi bi-tools kpi-icon" style="color:var(--kpi-materials-border)"></i>
          COSTO MATERIALI
        </p>
        <div class="d-flex align-items-baseline">
          <span class="kpi-value" style="color:var(--kpi-materials-border)"
                th:text="${#numbers.formatDecimal(totalAvgCostMaterials,1,'POINT',2,'COMMA')}">0,00</span>
          <span class="ms-2 text-muted fw-medium">€/t</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Sezione grafici: mensile + composizione -->
  <div class="dashboard-card p-4 mb-4">
    <div class="row g-4">
      <!-- Grafico mensile -->
      <div class="col-lg-7">
        <div class="section-header purple-border header-line">
          <div class="left">
            <h2 class="h6 mb-0 fw-bold" style="color:var(--purple)">
              <i class="bi bi-graph-up me-2"></i>
              Andamento medio del costo mensile
            </h2>
            <span class="badge bg-secondary bg-opacity-10" style="color:var(--purple)"
                  th:text="${crop!=null and !#strings.isEmpty(crop) ? crop : 'Tutte le Colture'}">
              Tutte le Colture
            </span>
          </div>
        </div>
        <p class="subtitle mb-3">
          Evoluzione del <strong>costo di produzione unitario (€/t)</strong>
          per area geografica nel mese selezionato (valori giornalieri).
        </p>
        <div class="chart-container">
          <canvas id="costMonthlyTrend" role="img"
                  aria-label="Grafico a linee sull'andamento del costo giornaliero nel mese selezionato."></canvas>
        </div>
      </div>
      <!-- Grafico composizione costi -->
      <div class="col-lg-5">
        <div class="section-header primary-border header-line">
          <div class="left">
            <h3 class="h6 mb-0 fw-bold text-primary">
              <i class="bi bi-bar-chart-fill me-2"></i>
              Scomposizione costi per area geografica
            </h3>
            <span class="badge bg-primary bg-opacity-10 text-primary"
                  th:text="${crop!=null and !#strings.isEmpty(crop) ? crop : 'Tutte le Colture'}">
              Tutte le Colture
            </span>
          </div>
        </div>
        <p class="subtitle mb-3">
          Analisi delle <strong>componenti di costo</strong> (manodopera, materiali)
          per ogni area nel periodo selezionato.
        </p>
        <div id="echBarCostComposition" class="chart-container"
             role="img" aria-label="Grafico a barre impilate dei costi per area."></div>
      </div>
    </div>
  </div>

  <!-- Sezione grafico annuale -->
  <div class="dashboard-card p-4 mb-4">
    <div class="section-header purple-border header-line">
      <div class="left">
        <h2 class="h6 mb-0 fw-bold" style="color:var(--purple)">
          <i class="bi bi-graph-up me-2"></i>
          Andamento medio del costo annuale
        </h2>
        <span class="badge bg-secondary bg-opacity-10" style="color:var(--purple)"
              th:text="${crop!=null and !#strings.isEmpty(crop) ? crop : 'Tutte le Colture'}">
          Tutte le Colture
        </span>
      </div>
    </div>
    <p class="subtitle mb-3">
      Evoluzione del <strong>costo di produzione unitario (€/t)</strong>
      per area geografica nel corso degli anni.
    </p>
    <div class="chart-container">
      <canvas id="costAnnualTrend" role="img"
              aria-label="Grafico a linee sull'andamento del costo negli anni."></canvas>
    </div>
  </div>

  <!-- Tabella dettagli -->
  <div class="dashboard-card p-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <h3 class="h6 mb-0 fw-bold" style="color:var(--purple)">
        <i class="bi bi-table me-2"></i>
        Dettaglio dei costi per area geografica
      </h3>
      <span class="badge bg-secondary"
            th:text="${crop!=null and !#strings.isEmpty(crop) ? crop : 'Tutte le colture'}">
        Tutte le colture
      </span>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
        <tr>
          <th scope="col">Area</th>
          <th scope="col" class="text-end">Costo Totale (€/t)</th>
          <th scope="col" class="text-end">Manodopera (€/t)</th>
          <th scope="col" class="text-end">Materiali (€/t)</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="r:${costiRows}">
          <td>
            <span class="fw-semibold" th:text="${r.area}">Area</span>
          </td>
          <td class="text-end fw-bold"
              th:text="${#numbers.formatDecimal(r.totalCost,1,'POINT',2,'COMMA')}">0,00</td>
          <td class="text-end"
              th:text="${#numbers.formatDecimal(r.laborCost,1,'POINT',2,'COMMA')}">0,00</td>
          <td class="text-end"
              th:text="${#numbers.formatDecimal(r.materialsCost,1,'POINT',2,'COMMA')}">0,00</td>
        </tr>
        </tbody>
        <tfoot class="table-light">
        <tr>
          <th scope="row">
            <i class="bi bi-calculator me-2"></i>Totale
          </th>
          <th class="text-end fw-bold"
              th:text="${#numbers.formatDecimal(totalAvgCost,1,'POINT',2,'COMMA')}">0,00</th>
          <th class="text-end"
              th:text="${#numbers.formatDecimal(totalAvgCostLabor,1,'POINT',2,'COMMA')}">0,00</th>
          <th class="text-end"
              th:text="${#numbers.formatDecimal(totalAvgCostMaterials,1,'POINT',2,'COMMA')}">0,00</th>
        </tr>
        </tfoot>
      </table>
      <p class="caption mt-3">
        <i class="bi bi-info-circle me-1"></i>
        I valori in tabella rappresentano le medie del periodo filtrato (mese/anno selezionati).
      </p>
    </div>
  </div>

  <footer class="text-center py-4 mt-5 border-top">
    <p class="text-muted small mb-0">
      &copy; <span th:text="${#temporals.year(#temporals.createNow())}">2025</span>
      AgrItalia S.p.A. | Dashboard Agronomica
    </p>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/common.js}"></script>

<script th:inline="javascript">
  window.costiData = {
    years: [[${years}]],
    annualCostNord: [[${annualCostNord}]],
    annualCostCentro: [[${annualCostCentro}]],
    annualCostSud: [[${annualCostSud}]],
    area: [[${area}]],
    avgCostLaborNord: [[${avgCostLaborNord}]],
    avgCostLaborCentro: [[${avgCostLaborCentro}]],
    avgCostLaborSud: [[${avgCostLaborSud}]],
    avgCostMaterialsNord: [[${avgCostMaterialsNord}]],
    avgCostMaterialsCentro: [[${avgCostMaterialsCentro}]],
    avgCostMaterialsSud: [[${avgCostMaterialsSud}]],
    // Serie mensile per grafico giornaliero del costo
    dailyLabels: [[${dailyLabels}]],
    dailyCostNord: [[${dailyCostNord}]],
    dailyCostCentro: [[${dailyCostCentro}]],
    dailyCostSud: [[${dailyCostSud}]]
  };
</script>

<script th:src="@{/js/costi.js}"></script>

</body>
</html>
