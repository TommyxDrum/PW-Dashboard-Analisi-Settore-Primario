<div th:fragment="kpi-cards(avgYieldHa, avgEff, avgCost, avgMargin, avgRisk, avgIpa, filterCrop, filterArea)" class="row mb-4" xmlns:th="http://www.thymeleaf.org">>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card p-3 h-100">
            <h3 class="card-title-compact">Resa/Ha</h3>
            <span class="badge badge-pill-kpi badge-success mb-2"><i class="bi bi-graph-up" aria-hidden="true"></i> Alta Produttività</span>
            <div class="kpi-value text-success" th:text="${#numbers.formatDecimal(avgYieldHa, 1, 'POINT', 2, 'COMMA')}">3.45</div>
            <span class="kpi-unit">t/Ha</span>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card p-3 h-100">
            <h3 class="card-title-compact">Efficienza Idrica</h3>
            <span class="badge badge-pill-kpi badge-info mb-2"><i class="bi bi-water" aria-hidden="true"></i> Sostenibilità</span>
            <div class="kpi-value text-info" th:text="${#numbers.formatDecimal(avgEff, 1, 'POINT', 2, 'COMMA')}">2.12</div>
            <span class="kpi-unit">Kg/m³</span>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card p-3 h-100">
            <h3 class="card-title-compact">Costo Unitario</h3>
            <span class="badge badge-pill-kpi badge-danger mb-2"><i class="bi bi-currency-euro" aria-hidden="true"></i> Gestione</span>
            <div class="kpi-value text-danger" th:text="${#numbers.formatDecimal(avgCost, 1, 'POINT', 2, 'COMMA')}">120.30</div>
            <span class="kpi-unit">€/t</span>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card p-3 h-100">
            <h3 class="card-title-compact">Margine Unitario</h3>
            <span class="badge badge-pill-kpi badge-primary mb-2"><i class="bi bi-cash-stack" aria-hidden="true"></i> Profitto</span>
            <div class="kpi-value text-primary" th:text="${#numbers.formatDecimal(avgMargin, 1, 'POINT', 2, 'COMMA')}">250.75</div>
            <span class="kpi-unit">€/t</span>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card p-3 h-100">
            <h3 class="card-title-compact">Rischio Climatico</h3>
            <span class="badge badge-pill-kpi badge-warning mb-2"><i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i> Mitigazione</span>
            <div class="kpi-value text-warning" th:text="${#numbers.formatDecimal(avgRisk * 100, 1, 'POINT', 0, 'COMMA') + '%'}">55%</div>
            <span class="kpi-unit">Indice (0..100)</span>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card p-3 h-100">
            <h3 class="card-title-compact">IPA</h3>
            <span class="badge badge-pill-kpi badge-dark mb-2"><i class="bi bi-award-fill" aria-hidden="true"></i> Performance</span>
            <div class="chart-container" style="height: 120px;">
                <canvas id="gaugeIPA" role="img" aria-label="Indice di Performance Aggregato a semicirconferenza" style="max-height: 120px;"></canvas>
            </div>
            <div class="text-center">
                <span class="kpi-value text-dark" th:text="${#numbers.formatDecimal(avgIpa, 1, 'POINT', 0, 'COMMA') + '%'}">78%</span>
            </div>
        </div>
    </div>

    <div class="col-12" th:if="${isEmpty}">
        <div class="alert alert-warning mt-3" role="alert">
            <h4 class="alert-heading">Nessun dato trovato!</h4>
            <p>Non ci sono record disponibili per i filtri selezionati (dal <span th:text="${filterFrom}"></span> al <span th:text="${filterTo}"></span>, Coltura: <span th:text="${filterCrop ?: 'Qualsiasi'}"></span>, Zona: <span th:text="${filterArea ?: 'Qualsiasi'}"></span>).</p>
        </div>
    </div>
</div>

<script th:inline="javascript" th:if="${!isEmpty}" xmlns:th="http://www.thymeleaf.org">
    /*<![CDATA[*/
    const avgIpa = /*[[${avgIpa}]]*/ 78.0;

    const dataGauge = {
        labels: ['IPA', 'Resto'],
        datasets: [{
            data: [avgIpa, 100.0 - avgIpa],
            backgroundColor: [
                avgIpa > 80 ? '#33a652' : (avgIpa > 50 ? '#ffb900' : '#e3000f'),
                '#e9ecef'
            ],
            borderWidth: 0,
            hoverOffset: 4
        }]
    };

    new Chart(document.getElementById('gaugeIPA'), {
        type: 'doughnut',
        data: dataGauge,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            rotation: -Math.PI, // Semicirconferenza
            circumference: Math.PI,
            cutout: '75%',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label === 'IPA') return `IPA: ${context.formattedValue}%`;
                            return null;
                        }
                    }
                }
            }
        }
    });
    /*]]>*/
</script>