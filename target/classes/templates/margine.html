<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AgrItalia • Margine di Profitto</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/css/common.css}"/>
    <link rel="stylesheet" th:href="@{/css/margine.css}"/>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>

<header class="header-bar">
    <a href="/" class="btn btn-outline-secondary btn-back" aria-label="Torna alla Dashboard">
        <i class="bi bi-arrow-left"></i>
    </a>
    <h1 class="header-logo display-6 fs-4 mb-0">
        <i class="bi bi-currency-euro me-2" style="color:var(--primary-green)"></i>
        Margine di Profitto
    </h1>
    <a href="#" id="exportLink" class="btn btn-outline-success ms-auto" aria-label="Esporta dati in CSV">
        <i class="bi bi-download me-1"></i>
        <span class="d-none d-sm-inline">Export</span>
    </a>
    <form th:action="@{/logout}" method="post" class="m-0">
        <button type="submit"
                class="btn btn-outline-danger"
                title="Esci dalla Dashboard"
                aria-label="Logout">
            <i class="bi bi-box-arrow-right me-1"></i>
            <span class="d-none d-sm-inline">Logout</span>
        </button>
    </form>
</header>

<div class="container-fluid py-4">

    <div class="dashboard-card p-3 mb-4">
        <form id="filterForm" action="/margine" method="get" class="filters-bar"
              role="group" aria-label="Filtri margine di profitto">
            <div class="form-group">
                <label class="form-label small text-muted mb-1 fw-semibold" for="monthSel">Mese</label>
                <select id="monthSel" class="form-select" aria-label="Seleziona mese">
                    <option value="1"  th:selected="${from!=null and #temporals.month(from)==1 }">Gennaio</option>
                    <option value="2"  th:selected="${from!=null and #temporals.month(from)==2 }">Febbraio</option>
                    <option value="3"  th:selected="${from!=null and #temporals.month(from)==3 }">Marzo</option>
                    <option value="4"  th:selected="${from!=null and #temporals.month(from)==4 }">Aprile</option>
                    <option value="5"  th:selected="${from!=null and #temporals.month(from)==5 }">Maggio</option>
                    <option value="6"  th:selected="${from!=null and #temporals.month(from)==6 }">Giugno</option>
                    <option value="7"  th:selected="${from!=null and #temporals.month(from)==7 }">Luglio</option>
                    <option value="8"  th:selected="${from!=null and #temporals.month(from)==8 }">Agosto</option>
                    <option value="9"  th:selected="${from!=null and #temporals.month(from)==9 }">Settembre</option>
                    <option value="10" th:selected="${from!=null and #temporals.month(from)==10}">Ottobre</option>
                    <option value="11" th:selected="${from!=null and #temporals.month(from)==11}">Novembre</option>
                    <option value="12" th:selected="${from!=null and #temporals.month(from)==12}">Dicembre</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label small text-muted mb-1 fw-semibold" for="yearSel">Anno</label>
                <select id="yearSel" class="form-select" aria-label="Seleziona anno">
                    <option th:each="y:${#numbers.sequence(2015,2025)}"
                            th:value="${y}"
                            th:text="${y}"
                            th:selected="${from!=null? #temporals.year(from)==y : y==#temporals.year(#temporals.createNow())}">
                        2025
                    </option>
                </select>
            </div>
            <div class="form-group" style="min-width:180px">
                <label class="form-label small text-muted mb-1 fw-semibold" for="cropSel">Coltura</label>
                <select id="cropSel" name="crop" class="form-select" aria-label="Seleziona coltura">
                    <option value="">Tutte le colture</option>
                    <option th:each="c:${cropsList}" th:value="${c}" th:text="${c}"
                            th:selected="${c==crop}">Coltura</option>
                </select>
            </div>
            <div class="form-group" style="min-width:180px">
                <label class="form-label small text-muted mb-1 fw-semibold" for="areaSel">Area</label>
                <select id="areaSel" name="area" class="form-select" aria-label="Seleziona area">
                    <option value="">Tutte le aree geografiche</option>
                    <option th:each="a:${areasList}" th:value="${a}" th:text="${a}"
                            th:selected="${a==area}">Area</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-funnel me-2"></i>
                <span>Applica</span>
            </button>
            <input type="hidden" id="from" name="startDate"
                   th:value="${from!=null? #temporals.format(from,'yyyy-MM-dd') : ''}"/>
            <input type="hidden" id="to" name="endDate"
                   th:value="${to!=null? #temporals.format(to,'yyyy-MM-dd') : ''}"/>
        </form>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-12 col-md-4">
            <div class="kpi-box price">
                <p class="small text-muted mb-2 fw-semibold">
                    <i class="bi bi-currency-euro kpi-icon" style="color:var(--kpi-price-border)"></i>
                    PREZZO MEDIO VENDITA
                </p>
                <div class="d-flex align-items-baseline">
          <span class="kpi-value" style="color:var(--kpi-price-border)"
                th:text="${#numbers.formatDecimal(totalAvgPrice,1,'POINT',2,'COMMA')}">0,00</span>
                    <span class="ms-2 text-muted fw-medium">€/t</span>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="kpi-box cost">
                <p class="small text-muted mb-2 fw-semibold">
                    <i class="bi bi-tag-fill kpi-icon" style="color:var(--kpi-cost-border)"></i>
                    COSTO UNITARIO MEDIO
                </p>
                <div class="d-flex align-items-baseline">
          <span class="kpi-value" style="color:var(--kpi-cost-border)"
                th:text="${#numbers.formatDecimal(totalAvgCost,1,'POINT',2,'COMMA')}">0,00</span>
                    <span class="ms-2 text-muted fw-medium">€/t</span>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="kpi-box margin">
                <p class="small text-muted mb-2 fw-semibold">
                    <i class="bi bi-graph-up-arrow kpi-icon" style="color:var(--kpi-margin-border)"></i>
                    MARGINE UNITARIO MEDIO
                </p>
                <div class="d-flex align-items-baseline">
          <span class="kpi-value" style="color:var(--kpi-margin-border)"
                th:text="${#numbers.formatDecimal(totalAvgMargin,1,'POINT',2,'COMMA')}">0,00</span>
                    <span class="ms-2 text-muted fw-medium">€/t</span>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-card p-4 mb-4">
        <div class="row g-4">
            <!-- Grafico mensile -->
            <div class="col-lg-7">
                <div class="section-header success-border header-line">
                    <div class="left">
                        <h2 class="h6 mb-0 fw-bold text-success">
                            <i class="bi bi-graph-up me-2"></i>
                            Andamento del margine di profitto - Mensile
                        </h2>
                        <span class="badge bg-success bg-opacity-10 text-success"
                              th:text="${crop!=null and !#strings.isEmpty(crop)? crop : 'Tutte le Colture'}">
              Tutte le Colture
            </span>
                    </div>
                </div>
                <p class="subtitle mb-3">
                    Il grafico mostra il <strong>profitto o la perdita per ogni tonnellata venduta</strong>
                    in ciascuna regione (Nord, Centro, Sud) durante il mese selezionato.
                </p>
                <div class="chart-container">
                    <canvas id="marginMonthlyTrend" role="img"
                            aria-label="Grafico a linee sull'andamento del margine giornaliero nel mese selezionato."></canvas>
                </div>
            </div>
            <!-- Grafico composizione prezzo vendita -->
            <div class="col-lg-5">
                <div class="section-header primary-border header-line">
                    <div class="left">
                        <h3 class="h6 mb-0 fw-bold text-primary">
                            <i class="bi bi-bar-chart-fill me-2"></i>
                            Composizione del prezzo di vendita - Mensile
                        </h3>
                        <span class="badge bg-primary bg-opacity-10 text-primary"
                              th:text="${crop!=null and !#strings.isEmpty(crop)? crop : 'Tutte le Colture'}">
              Tutte le Colture
            </span>
                    </div>
                </div>
                <p class="subtitle mb-3">
                    Il grafico mostra come si divide il <strong>prezzo di vendita</strong> in due parti:
                    <br>
                    • <strong>Costo</strong>: Quanto hai speso per produrre (materie prime, manodopera, acqua, ecc.)
                    <br>
                    • <strong>Margine</strong>: Quanto rimane di profitto dopo aver pagato i costi
                </p>
                <div id="echBarMarginComposition" class="chart-container"
                     role="img" aria-label="Grafico a barre impilate costo vs margine per area."></div>
            </div>
        </div>
    </div>

    <!-- Grafico annuale spostato sotto: copre tutta la larghezza -->
    <div class="dashboard-card p-4 mb-4">
        <div class="section-header success-border header-line">
            <div class="left">
                <h2 class="h6 mb-0 fw-bold text-success">
                    <i class="bi bi-graph-up me-2"></i>
                    Andamento del margine di profitto - Annuale
                </h2>
                <span class="badge bg-success bg-opacity-10 text-success"
                      th:text="${crop!=null and !#strings.isEmpty(crop)? crop : 'Tutte le Colture'}">
          Tutte le Colture
        </span>
            </div>
        </div>
        <p class="subtitle mb-3">
            Il grafico mostra l'<strong>andamento storico del profitto per tonnellata</strong>
            in ogni regione dal 2015 ad oggi.
            <br>
            Utile per capire:
            <br>
            • Se il margine è <strong>in crescita</strong> (affari migliorano)
            <br>
            • Se è <strong>in calo</strong> (attenzione: o i prezzi calano o i costi salgono)
            <br>
            • Quale regione ha <strong>maggior redditività</strong> nel tempo
        </p>
        <div class="chart-container">
            <canvas id="marginAnnualTrend" role="img"
                    aria-label="Grafico a linee sull'andamento del margine annuale."></canvas>
        </div>
    </div>

    <div class="dashboard-card p-4">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
            <h3 class="h6 mb-0 fw-bold text-success">
                <i class="bi bi-table me-2"></i>
                Dettaglio margine di profitto per area
            </h3>
            <span class="badge bg-secondary"
                  th:text="${crop!=null and !#strings.isEmpty(crop)? crop : 'Tutte le colture'}">
        Tutte le colture
      </span>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                <tr>
                    <th scope="col">Area</th>
                    <th scope="col" class="text-end">Prezzo Medio (€/t)</th>
                    <th scope="col" class="text-end">Costo Medio (€/t)</th>
                    <th scope="col" class="text-end">Margine Medio (€/t)</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="r:${margineRows}">
                    <td>
                        <span class="fw-semibold" th:text="${r.area}">Area</span>
                    </td>
                    <td class="text-end"
                        th:text="${#numbers.formatDecimal(r.price,1,'POINT',2,'COMMA')}">0,00</td>
                    <td class="text-end"
                        th:text="${#numbers.formatDecimal(r.cost,1,'POINT',2,'COMMA')}">0,00</td>
                    <td class="text-end fw-bold" style="color:var(--primary-green)"
                        th:text="${#numbers.formatDecimal(r.margin,1,'POINT',2,'COMMA')}">0,00</td>
                </tr>
                </tbody>
                <tfoot class="table-light">
                <tr>
                    <th scope="row">
                        <i class="bi bi-calculator me-2"></i>Totale
                    </th>
                    <th class="text-end"
                        th:text="${#numbers.formatDecimal(totalAvgPrice,1,'POINT',2,'COMMA')}">0,00</th>
                    <th class="text-end"
                        th:text="${#numbers.formatDecimal(totalAvgCost,1,'POINT',2,'COMMA')}">0,00</th>
                    <th class="text-end fw-bold" style="color:var(--primary-green)"
                        th:text="${#numbers.formatDecimal(totalAvgMargin,1,'POINT',2,'COMMA')}">0,00</th>
                </tr>
                </tfoot>
            </table>
            <p class="caption mt-3">
                <i class="bi bi-info-circle me-1"></i>
                I valori in tabella rappresentano le medie del periodo filtrato (mese/anno selezionati).
            </p>
        </div>
    </div>

    <footer class="bg-white border-top shadow-sm py-4 mt-5 text-center">
        <p class="text-muted small mb-0">
            &copy; <span th:text="${#temporals.year(#temporals.createNow())}">2025</span>
            AgrItalia S.p.A. | Dashboard
        </p>
    </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/common.js}"></script>

<script th:inline="javascript">
    window.margineData = {
      years: [[${years}]],
      annualMarginNord: [[${annualMarginNord}]],
      annualMarginCentro: [[${annualMarginCentro}]],
      annualMarginSud: [[${annualMarginSud}]],
      area: [[${area}]],
      avgCostNord: [[${avgCostNord}]],
      avgCostCentro: [[${avgCostCentro}]],
      avgCostSud: [[${avgCostSud}]],
      avgMarginNord: [[${avgMarginNord}]],
      avgMarginCentro: [[${avgMarginCentro}]],
      avgMarginSud: [[${avgMarginSud}]],
      // Serie mensile per grafico giornaliero
      dailyLabels: [[${dailyLabels}]],
      dailyMarginNord: [[${dailyMarginNord}]],
      dailyMarginCentro: [[${dailyMarginCentro}]],
      dailyMarginSud: [[${dailyMarginSud}]]
    };
</script>

<script th:src="@{/js/margine.js}"></script>

</body>
</html>
