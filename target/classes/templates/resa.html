<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AgrItalia â€¢ Resa terreno</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/css/common.css}"/>
    <link rel="stylesheet" th:href="@{/css/resa.css}"/>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>

<header class="header-bar">
    <a href="/" class="btn btn-outline-secondary btn-back" aria-label="Torna alla Dashboard">
        <i class="bi bi-arrow-left"></i>
    </a>
    <h1 class="header-logo display-6 fs-4 mb-0">
        <i class="bi bi-graph-up-arrow me-2" style="color:var(--primary-green)"></i>
        Resa del terreno per ettaro
    </h1>
    <a href="#" id="exportLink" class="btn btn-outline-success ms-auto" aria-label="Esporta i dati filtrati in formato CSV">
        <i class="bi bi-download me-1"></i>
        <span class="d-none d-sm-inline">Export</span>
    </a>
</header>

<div class="container-fluid py-4">

    <!-- Barra filtri -->
    <div class="dashboard-card p-3 mb-4">
        <form id="filterForm" action="/resa" method="get" class="filters-bar"
              role="group" aria-label="Filtri resa">
            <div class="form-group">
                <label class="form-label small text-muted mb-1 fw-semibold" for="monthSel">Mese</label>
                <select id="monthSel" class="form-select" aria-label="Seleziona mese">
                    <option value="1"  th:selected="${from != null and #temporals.month(from) == 1 }">Gennaio</option>
                    <option value="2"  th:selected="${from != null and #temporals.month(from) == 2 }">Febbraio</option>
                    <option value="3"  th:selected="${from != null and #temporals.month(from) == 3 }">Marzo</option>
                    <option value="4"  th:selected="${from != null and #temporals.month(from) == 4 }">Aprile</option>
                    <option value="5"  th:selected="${from != null and #temporals.month(from) == 5 }">Maggio</option>
                    <option value="6"  th:selected="${from != null and #temporals.month(from) == 6 }">Giugno</option>
                    <option value="7"  th:selected="${from != null and #temporals.month(from) == 7 }">Luglio</option>
                    <option value="8"  th:selected="${from != null and #temporals.month(from) == 8 }">Agosto</option>
                    <option value="9"  th:selected="${from != null and #temporals.month(from) == 9 }">Settembre</option>
                    <option value="10" th:selected="${from != null and #temporals.month(from) == 10}">Ottobre</option>
                    <option value="11" th:selected="${from != null and #temporals.month(from) == 11}">Novembre</option>
                    <option value="12" th:selected="${from != null and #temporals.month(from) == 12}">Dicembre</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label small text-muted mb-1 fw-semibold" for="yearSel">Anno</label>
                <select id="yearSel" class="form-select" aria-label="Seleziona anno">
                    <option th:each="y : ${#numbers.sequence(2015, 2025)}"
                            th:value="${y}"
                            th:text="${y}"
                            th:selected="${from != null ? #temporals.year(from) == y : y == #temporals.year(#temporals.createNow())}">
                        2025
                    </option>
                </select>
            </div>
            <div class="form-group" style="min-width:180px">
                <label class="form-label small text-muted mb-1 fw-semibold" for="cropSel">Coltura</label>
                <select id="cropSel" name="crop" class="form-select" aria-label="Seleziona coltura">
                    <option value="">Tutte le colture</option>
                    <option th:each="c : ${cropsList}" th:value="${c}" th:text="${c}"
                            th:selected="${c == crop}">Coltura</option>
                </select>
            </div>
            <div class="form-group" style="min-width:180px">
                <label class="form-label small text-muted mb-1 fw-semibold" for="areaSel">Area</label>
                <select id="areaSel" name="area" class="form-select" aria-label="Seleziona area">
                    <option value="">Tutte le aree</option>
                    <option th:each="a : ${areasList}" th:value="${a}" th:text="${a}"
                            th:selected="${a == area}">Area</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-funnel me-2"></i>
                <span>Applica</span>
            </button>
            <input type="hidden" id="from" name="startDate"
                   th:value="${from != null ? #temporals.format(from,'yyyy-MM-dd') : ''}"/>
            <input type="hidden" id="to" name="endDate"
                   th:value="${to != null ? #temporals.format(to,'yyyy-MM-dd') : ''}"/>
        </form>
    </div>

    <!-- Card KPI -->
    <div class="row g-4 mb-4">
        <div class="col-12 col-md-4">
            <div class="kpi-box prod">
                <p class="small text-muted mb-2 fw-semibold">
                    <i class="bi bi-box-seam-fill kpi-icon" style="color:var(--pie-prod)"></i>
                    PRODUZIONE TOTALE
                </p>
                <div class="d-flex align-items-baseline">
                    <span class="kpi-value" style="color:var(--pie-prod)" id="totalValueProd">-</span>
                    <span class="ms-2 text-muted fw-medium">t</span>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="kpi-box surf">
                <p class="small text-muted mb-2 fw-semibold">
                    <i class="bi bi-rulers kpi-icon" style="color:var(--pie-surf)"></i>
                    SUPERFICIE TOTALE
                </p>
                <div class="d-flex align-items-baseline">
                    <span class="kpi-value" style="color:var(--pie-surf)" id="totalValueSurf">-</span>
                    <span class="ms-2 text-muted fw-medium">ha</span>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="kpi-box resa">
                <p class="small text-muted mb-2 fw-semibold">
                    <i class="bi bi-graph-up-arrow kpi-icon" style="color:var(--pie-resa)"></i>
                    RESA MEDIA TOTALE
                </p>
                <div class="d-flex align-items-baseline">
                    <span class="kpi-value" style="color:var(--pie-resa)" id="totalValueResa">-</span>
                    <span class="ms-2 text-muted fw-medium">t/ha</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Sezione grafici: mensile + donut -->
    <div class="dashboard-card p-4 mb-4">
        <div class="row g-4">
            <!-- Grafico mensile -->
            <div class="col-lg-7">
                <div class="section-header success-border header-line">
                    <div class="left">
                        <h2 class="h6 mb-0 fw-bold text-success">
                            <i class="bi bi-graph-up me-2"></i>
                            Andamento Storico della Resa Mensile
                        </h2>
                        <span class="badge bg-success bg-opacity-10 text-success"
                              th:text="${crop != null && !#strings.isEmpty(crop) ? crop : 'Tutte le Colture'}">
              Tutte le Colture
            </span>
                    </div>
                </div>
                <p class="subtitle mb-3">
                    Evoluzione della <strong>resa (t/ha)</strong> per area geografica
                    nel mese selezionato (valori giornalieri).
                </p>
                <div class="chart-container">
                    <canvas id="resaMonthlyTrend" role="img"
                            aria-label="Grafico a linee sull'andamento della resa giornaliera nel mese selezionato."></canvas>
                </div>
            </div>
            <!-- Grafico donut -->
            <div class="col-lg-5">
                <div class="section-header primary-border header-line">
                    <div class="left">
                        <h3 class="h6 mb-0 fw-bold text-primary">
                            <i class="bi bi-pie-chart-fill me-2"></i>
                            Composizione Produzione
                        </h3>
                        <span class="badge bg-primary bg-opacity-10 text-primary"
                              th:text="${crop != null && !#strings.isEmpty(crop) ? crop : 'Tutte le Colture'}">
              Tutte le Colture
            </span>
                    </div>
                </div>
                <p class="subtitle mb-3">
                    Contributo percentuale di ciascuna area alla <strong>produzione totale</strong>
                    in tonnellate.
                </p>
                <div id="echDonutYield" class="chart-container"
                     role="img" aria-label="Grafico ad anello sulla ripartizione percentuale della produzione."></div>
            </div>
        </div>
    </div>

    <!-- Sezione grafico annuale -->
    <div class="dashboard-card p-4 mb-4">
        <div class="section-header success-border header-line">
            <div class="left">
                <h2 class="h6 mb-0 fw-bold text-success">
                    <i class="bi bi-graph-up me-2"></i>
                    Andamento Storico della Resa Annuale
                </h2>
                <span class="badge bg-success bg-opacity-10 text-success"
                      th:text="${crop != null && !#strings.isEmpty(crop) ? crop : 'Tutte le Colture'}">
          Tutte le Colture
        </span>
            </div>
        </div>
        <p class="subtitle mb-3">
            Evoluzione della <strong>resa (t/ha)</strong> per area geografica
            nel corso degli anni.
        </p>
        <div class="chart-container">
            <canvas id="resaAnnualTrend" role="img"
                    aria-label="Grafico a linee sull'andamento della resa negli anni."></canvas>
        </div>
    </div>

    <!-- Tabella dettagli -->
    <div class="dashboard-card p-4">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
            <h3 class="h6 mb-0 fw-bold text-success">
                <i class="bi bi-table me-2"></i>
                Dettaglio Dati per Area
            </h3>
            <span class="badge bg-secondary"
                  th:text="${crop != null && !#strings.isEmpty(crop) ? crop : 'Tutte le colture'}">
        Tutte le colture
      </span>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                <tr>
                    <th scope="col">Area</th>
                    <th scope="col" class="text-end">Produzione (t)</th>
                    <th scope="col" class="text-end">Superficie (ha)</th>
                    <th scope="col" class="text-end">Resa (t/ha)</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="r : ${resaRows}">
                    <td>
                        <span class="fw-semibold" th:text="${r.area}">Area</span>
                    </td>
                    <td class="text-end"
                        th:text="${#numbers.formatDecimal(r.yieldT,1,'POINT',2,'COMMA')}">0,00</td>
                    <td class="text-end"
                        th:text="${#numbers.formatDecimal(r.surfaceHa,1,'POINT',2,'COMMA')}">0,00</td>
                    <td class="text-end fw-bold"
                        th:text="${#numbers.formatDecimal(r.resa,1,'POINT',2,'COMMA')}">0,00</td>
                </tr>
                </tbody>
                <tfoot class="table-light">
                <tr>
                    <th scope="row">
                        <i class="bi bi-calculator me-2"></i>Totale
                    </th>
                    <th class="text-end"
                        th:text="${#numbers.formatDecimal(totalYieldT,1,'POINT',2,'COMMA')}">0,00</th>
                    <th class="text-end"
                        th:text="${#numbers.formatDecimal(totalSurfaceHa,1,'POINT',2,'COMMA')}">0,00</th>
                    <th class="text-end fw-bold"
                        th:text="${#numbers.formatDecimal(totalResa,1,'POINT',2,'COMMA')}">0,00</th>
                </tr>
                </tfoot>
            </table>
            <p class="caption mt-3">
                <i class="bi bi-info-circle me-1"></i>
                Le cifre in tabella sono aggregate in base ai filtri selezionati.
            </p>
        </div>
    </div>

    <footer class="text-center py-4 mt-5 border-top">
        <p class="text-muted small mb-0">
            &copy; <span th:text="${#temporals.year(#temporals.createNow())}">2025</span>
            AgrItalia S.p.A. | Dashboard Agronomica
        </p>
    </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/common.js}"></script>

<script th:inline="javascript">
    window.resaData = {
      years: [[${years}]],
      annualResaNord: [[${annualResaNord}]],
      annualResaCentro: [[${annualResaCentro}]],
      annualResaSud: [[${annualResaSud}]],
      area: [[${area}]],
      yieldNordT: [[${yieldNordT}]],
      yieldCentroT: [[${yieldCentroT}]],
      yieldSudT: [[${yieldSudT}]],
      surfNordHa: [[${surfNordHa}]],
      surfCentroHa: [[${surfCentroHa}]],
      surfSudHa: [[${surfSudHa}]],
      totalYieldT: [[${totalYieldT}]],
      totalSurfaceHa: [[${totalSurfaceHa}]],
      totalResa: [[${totalResa}]],
      // Serie mensile per grafico giornaliero della resa
      dailyLabels: [[${dailyLabels}]],
      dailyResaNord: [[${dailyResaNord}]],
      dailyResaCentro: [[${dailyResaCentro}]],
      dailyResaSud: [[${dailyResaSud}]]
    };
</script>
<script th:src="@{/js/resa.js}"></script>

</body>
</html>
