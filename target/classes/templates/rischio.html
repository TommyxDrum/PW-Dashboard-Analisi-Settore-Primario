<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-italia@2.11.2/dist/css/bootstrap-italia.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<link rel="stylesheet" th:href="@{/css/styles.css}">
      th:replace="fragments/layout :: layout(~{::main-content}, ~{::page-scripts}, ${pageTitle}, ${pageId}, ${cropsList}, ${areasList})">

<main-content th:fragment="main-content">

  <div class="row mb-4">
    <div class="col-12">
      <p class="text-muted">
        Analisi del Rischio Climatico, calcolato come indice normalizzato (0 a 1) basato su temperatura, umidità e pioggia.
        Identifica i campi e le colture più esposte.
      </p>
    </div>
  </div>

  <div th:replace="~{fragments/filters :: filter-toolbar(
        ${filterFrom}, ${filterTo}, ${filterCrop}, ${filterArea}, ${cropsList}, ${areasList}, ${startDate2024}, ${endDate2024}
    )}">Toolbar Filtri</div>

  <div th:replace="~{fragments/cards :: kpi-cards(
        ${avgYieldHa}, ${avgEff}, ${avgCost}, ${avgMargin}, ${avgRisk}, ${avgIpa}, ${filterCrop}, ${filterArea}
    )}">KPI Cards</div>

  <hr class="section-separator"/>

  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card p-3 h-100">
        <h3 class="h6 fw-bold card-title">Rischio Climatico Medio per Campo</h3>
        <p class="small text-muted">Indice normalizzato 0 (basso) a 1 (alto).</p>
        <div class="chart-container" style="height: 400px;">
          <canvas id="riskByField" role="img" aria-label="Grafico a barre orizzontali del Rischio Climatico per Campo"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-6 mb-4">
      <div class="card p-3 h-100">
        <h3 class="h6 fw-bold card-title">Rischio Climatico Medio per Coltura</h3>
        <div class="chart-container">
          <canvas id="riskByCrop" role="img" aria-label="Grafico a barre del Rischio Climatico per Coltura"></canvas>
        </div>
      </div>
    </div>
  </div>

  <hr class="section-separator"/>

  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card p-3 h-100">
        <h3 class="h6 fw-bold card-title">Rischio Climatico Medio per Zona</h3>
        <div class="chart-container">
          <canvas id="riskByArea" role="img" aria-label="Grafico a barre del Rischio Climatico per Zona"></canvas>
        </div>
      </div>
    </div>
  </div>

</main-content>

<th:block th:fragment="page-scripts">
  <script th:inline="javascript">
    /*<![CDATA[*/
    const avgRiskByField = /*[[${avgRiskByField}]]*/ {};
    const avgRiskByCrop = /*[[${avgRiskByCrop}]]*/ {};
    const avgRiskByArea = /*[[${avgRiskByArea}]]*/ {};
    const cropsList = /*[[${cropsList}]]*/ [];
    const areasList = /*[[${areasList}]]*/ [];
    const isEmpty = /*[[${isEmpty}]]*/ false;


    if (!isEmpty) {
        // 1. Rischio Climatico per Campo (Bar Orizzontale)
        const fieldLabels = Object.keys(avgRiskByField);
        const riskData = Object.values(avgRiskByField);

        new Chart(document.getElementById('riskByField'), {
            type: 'bar',
            data: {
                labels: fieldLabels,
                datasets: [{
                    label: 'Rischio (0..1)',
                    data: riskData,
                    backgroundColor: '#ffb900',
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 1.0,
                        title: { display: true, text: 'Indice Rischio (0=Basso, 1=Alto)' }
                    }
                },
                plugins: { legend: { position: 'bottom' } }
            }
        });


        // 2. Rischio Climatico per Coltura (Bar)
        const cropRiskLabels = cropsList.filter(c => avgRiskByCrop[c] != null);
        const cropRiskData = cropRiskLabels.map(c => avgRiskByCrop[c]);

        new Chart(document.getElementById('riskByCrop'), {
            type: 'bar',
            data: {
                labels: cropRiskLabels,
                datasets: [{
                    label: 'Rischio (0..1)',
                    data: cropRiskData,
                    backgroundColor: '#ffb900',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, max: 1.0 } },
                plugins: { legend: { position: 'bottom' } }
            }
        });


        // 3. Rischio Climatico per Zona (Bar)
        const areaRiskLabels = areasList.filter(a => avgRiskByArea[a] != null);
        const areaRiskData = areaRiskLabels.map(a => avgRiskByArea[a]);

        new Chart(document.getElementById('riskByArea'), {
            type: 'bar',
            data: {
                labels: areaRiskLabels,
                datasets: [{
                    label: 'Rischio (0..1)',
                    data: areaRiskData,
                    backgroundColor: '#ffb900',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, max: 1.0 } },
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }
    /*]]>*/
  </script>
</th:block>
</html>